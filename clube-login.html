<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Clube Prato & Peso – Acesso</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f5f5f7;
      --bg-alt: #ffffff;
      --primary: #1e5a4d;
      --primary-soft: #e0f3ec;
      --accent: #ffb347;
      --accent-soft: #fff3df;
      --text-main: #222222;
      --text-muted: #666666;
      --border-soft: #e0e0e0;
      --radius-lg: 18px;
      --shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.08);
      --max-width: 1040px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf5ea 0, #f5f5f7 45%, #f0f2f5 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    header {
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      flex-wrap: wrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #4b2c15;
      font-size: 0.95rem;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
    }

    .logo-text-main {
      font-weight: 700;
      font-size: 1.05rem;
      letter-spacing: 0.03em;
    }

    .logo-text-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    main {
      flex: 1;
      padding: 26px 16px 40px;
    }

    .main-inner {
      max-width: 720px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 0.95rem;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    .card {
      background: var(--bg-alt);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);
      padding: 18px 18px 18px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .tab-btn {
      flex: 1 1 160px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 8px 10px;
      background: #f9fafb;
      cursor: pointer;
      font-size: 0.85rem;
      text-align: center;
      color: var(--text-main);
    }

    .tab-btn.active {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
      font-weight: 600;
    }

    .tab-content {
      display: none;
      margin-top: 4px;
    }

    .tab-content.active {
      display: block;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      box-sizing: border-box;
      background: #f9fafb;
    }

    .help-text {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .btn-primary {
      margin-top: 14px;
      width: 100%;
      background: #155e3b;
      color: #ffffff;
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.2);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .msg-erro {
      margin-top: 8px;
      font-size: 0.86rem;
      color: #b91c1c;
    }

    .msg-ok {
      margin-top: 8px;
      font-size: 0.86rem;
      color: #15803d;
    }

    .info-box {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #ecfdf3;
      border: 1px solid #bbf7d0;
      font-size: 0.83rem;
      color: #166534;
    }

    .info-box strong {
      font-weight: 600;
    }

    .link-button {
      margin-top: 6px;
      background: none;
      border: none;
      padding: 0;
      color: var(--primary);
      font-size: 0.8rem;
      cursor: pointer;
      text-decoration: underline;
      text-align: left;
    }

    .link-button:disabled {
      opacity: 0.6;
      cursor: default;
      text-decoration: none;
    }

    @media (max-width: 640px) {
      main {
        padding-inline: 12px;
      }
      .header-inner {
        padding-inline: 10px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-badge">P&amp;P</div>
        <div>
          <div class="logo-text-main">Prato &amp; Peso</div>
          <div class="logo-text-sub">Clube Prato &amp; Peso</div>
        </div>
      </a>
    </div>
  </header>

  <main>
    <div class="main-inner">
      <h1>Clube Prato &amp; Peso</h1>
      <p class="subtitle">
        Acompanhe sua evolução com seus dados salvos na nuvem. Acesso exclusivo via código.
      </p>

      <div class="card">
        <div class="tabs">
          <button class="tab-btn active" data-tab="primeiroAcesso">Primeiro acesso (tenho código)</button>
          <button class="tab-btn" data-tab="login">Já tenho login e senha</button>
        </div>

        <!-- PRIMEIRO ACESSO -->
        <div class="tab-content active" id="tab-primeiroAcesso">
          <label for="paNome">Nome ou apelido</label>
          <input type="text" id="paNome" placeholder="Seu nome" />

          <label for="paEmail">E-mail</label>
          <input type="email" id="paEmail" placeholder="voce@exemplo.com" />

          <label for="paSenha">Criar senha</label>
          <input type="password" id="paSenha" />

          <label for="paSenha2">Confirmar senha</label>
          <input type="password" id="paSenha2" />

          <label for="paCodigo">Código de acesso (liberado após pagamento)</label>
          <input type="text" id="paCodigo" placeholder="Ex: PPE2025VIP" />
          <div class="help-text">
            Você usa esse código apenas no primeiro acesso. Depois, entra só com e-mail e senha.
          </div>

          <button class="btn-primary" id="btnPrimeiroAcesso">
            Criar minha conta e entrar no Clube
          </button>
          <div id="paMensagem" class="msg-erro"></div>

          <div class="info-box">
            <strong>Como funciona na prática?</strong><br />
            Você recebe o código comigo (Pix / combinado), faz o primeiro acesso e a partir daí entra
            só com seu e-mail e senha. Seus dados ficam vinculados à sua conta.
          </div>
        </div>

        <!-- LOGIN NORMAL (inclui admin) -->
        <div class="tab-content" id="tab-login">
          <label for="loginEmail">E-mail</label>
          <input type="email" id="loginEmail" placeholder="voce@exemplo.com" />

          <label for="loginSenha">Senha</label>
          <input type="password" id="loginSenha" />

          <button class="btn-primary" id="btnLogin">
            Entrar no Clube
          </button>

          <!-- Esqueci minha senha -->
          <button type="button" class="link-button" id="btnEsqueciSenha">
            Esqueci minha senha
          </button>

          <div id="loginMensagem" class="msg-erro"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Config oficial do projeto
    const firebaseConfig = {
      apiKey: "AIzaSyABfAWUAW6a6g93B9QKooTKd5Mj645G3vE",
      authDomain: "prato-e-peso-77b5a.firebaseapp.com",
      projectId: "prato-e-peso-77b5a",
      storageBucket: "prato-e-peso-77b5a.firebasestorage.app",
      messagingSenderId: "432109202072",
      appId: "1:432109202072:web:1c8636db0c161318ddfeed"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    // E-mails que têm acesso ao painel de administrador
    const ADMIN_EMAILS = [
      "rafaelbrito162@gmail.com".toLowerCase()
      // se quiser, pode adicionar outros e-mails aqui
      // "rafael-brito13@hotmail.com".toLowerCase(),
    ];

    const MODO_TESTE_LOCAL = location.protocol === "file:";

    const CODIGOS_CLUBE = [
      {
        codigo: "PPE2025VIP",
        nomePlano: "VIP 2025 – fundador",
        descricao: "Plano de testes / lote fundador",
        validoDe: "2024-01-01",
        validoAte: "2030-12-31",
        ativo: true
      }
    ];

    function normalizarCodigo(c) {
      return (c || "").toString().trim().toUpperCase();
    }

    function validarCodigoAcesso(codigoDigitado) {
      if (MODO_TESTE_LOCAL) {
        return {
          ok: true,
          mensagem: "",
          motivo: "teste-local",
          plano: {
            codigo: "TESTE_LOCAL",
            nomePlano: "Teste local",
            descricao: "Acesso liberado em ambiente local"
          }
        };
      }

      const cod = normalizarCodigo(codigoDigitado);
      if (!cod) {
        return {
          ok: false,
          mensagem: "Informe o código de acesso que recebeu comigo."
        };
      }

      const encontrado = CODIGOS_CLUBE.find((item) => normalizarCodigo(item.codigo) === cod);

      if (!encontrado) {
        return {
          ok: false,
          mensagem: "Código de acesso inválido ou de outro período. Confira com o Rafael."
        };
      }

      if (!encontrado.ativo) {
        return {
          ok: false,
          mensagem: "Este código não está mais ativo. Fale comigo para gerar um novo."
        };
      }

      const hoje = new Date();
      const dataHoje = hoje.toISOString().slice(0, 10);

      if (dataHoje < encontrado.validoDe || dataHoje > encontrado.validoAte) {
        return {
          ok: false,
          mensagem: "Código de acesso inválido ou expirado. Fale comigo para atualizar."
        };
      }

      return {
        ok: true,
        mensagem: "",
        plano: encontrado
      };
    }

    function salvarLocalStorageAcesso(user, planoInfo) {
      try {
        localStorage.setItem("pp_user_uid", user.uid);
        localStorage.setItem("pp_user_email", user.email || "");
        if (user.displayName) {
          localStorage.setItem("pp_user_nome", user.displayName);
        }
        if (planoInfo) {
          localStorage.setItem("pp_plano_codigo", planoInfo.codigo || "");
          localStorage.setItem("pp_plano_nome", planoInfo.nomePlano || "");
        }
      } catch (e) {
        console.warn("Não foi possível salvar no localStorage:", e);
      }
    }

    function mostrarMensagem(el, texto, ok = false) {
      el.textContent = texto || "";
      el.className = "";
      if (!texto) return;
      el.classList.add(ok ? "msg-ok" : "msg-erro");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabContents = {
        primeiroAcesso: document.getElementById("tab-primeiroAcesso"),
        login: document.getElementById("tab-login")
      };

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.getAttribute("data-tab");

          tabButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          Object.keys(tabContents).forEach((key) => {
            tabContents[key].classList.remove("active");
          });
          tabContents[tab].classList.add("active");
        });
      });

      // PRIMEIRO ACESSO
      const paNome = document.getElementById("paNome");
      const paEmail = document.getElementById("paEmail");
      const paSenha = document.getElementById("paSenha");
      const paSenha2 = document.getElementById("paSenha2");
      const paCodigo = document.getElementById("paCodigo");
      const btnPrimeiroAcesso = document.getElementById("btnPrimeiroAcesso");
      const paMensagem = document.getElementById("paMensagem");

      btnPrimeiroAcesso.addEventListener("click", async () => {
        mostrarMensagem(paMensagem, "");

        const nome = paNome.value.trim();
        const email = paEmail.value.trim();
        const senha = paSenha.value;
        const senha2 = paSenha2.value;
        const codigo = paCodigo.value;

        if (!nome) {
          mostrarMensagem(paMensagem, "Informe seu nome ou apelido.");
          return;
        }
        if (!email) {
          mostrarMensagem(paMensagem, "Informe seu e-mail.");
          return;
        }
        if (!senha || senha.length < 6) {
          mostrarMensagem(paMensagem, "Crie uma senha com pelo menos 6 caracteres.");
          return;
        }
        if (senha !== senha2) {
          mostrarMensagem(paMensagem, "A confirmação de senha não confere.");
          return;
        }

        const validacao = validarCodigoAcesso(codigo);
        if (!validacao.ok) {
          mostrarMensagem(paMensagem, validacao.mensagem || "Código de acesso inválido.");
          return;
        }

        btnPrimeiroAcesso.disabled = true;
        mostrarMensagem(paMensagem, "Criando sua conta...", true);

        try {
          const cred = await auth.createUserWithEmailAndPassword(email, senha);
          const user = cred.user;

          if (user) {
            if (nome) {
              await user.updateProfile({ displayName: nome });
            }

            const plano = validacao.plano || {};

            await db.collection("usuarios").doc(user.uid).set(
              {
                nome: nome,
                email: email,
                codigoAcesso: plano.codigo || null,
                planoNome: plano.nomePlano || null,
                origem: "clube",
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              },
              { merge: true }
            );

            salvarLocalStorageAcesso(user, plano);
            try {
              localStorage.setItem("pp_is_admin", "0");
            } catch (e) {}

            window.location.href = "clube-area.html";
          }
        } catch (err) {
          console.error("Erro no primeiro acesso:", err);
          let msg = "Erro ao criar sua conta. Tente novamente.";
          if (err.code === "auth/email-already-in-use") {
            msg = "Este e-mail já está em uso. Use a aba 'Já tenho login e senha'.";
          }
          mostrarMensagem(paMensagem, msg);
        } finally {
          btnPrimeiroAcesso.disabled = false;
        }
      });

      // LOGIN NORMAL (inclui admin)
      const loginEmail = document.getElementById("loginEmail");
      const loginSenha = document.getElementById("loginSenha");
      const btnLogin = document.getElementById("btnLogin");
      const btnEsqueciSenha = document.getElementById("btnEsqueciSenha");
      const loginMensagem = document.getElementById("loginMensagem");

      btnLogin.addEventListener("click", async () => {
        mostrarMensagem(loginMensagem, "");

        const email = loginEmail.value.trim();
        const senha = loginSenha.value;

        if (!email || !senha) {
          mostrarMensagem(loginMensagem, "Informe e-mail e senha.");
          return;
        }

        btnLogin.disabled = true;
        mostrarMensagem(loginMensagem, "Entrando...", true);

        try {
          const cred = await auth.signInWithEmailAndPassword(email, senha);
          const user = cred.user;

          if (user) {
            const emailLower = (user.email || "").toLowerCase();
            const isAdmin = ADMIN_EMAILS.includes(emailLower);

            salvarLocalStorageAcesso(user, null);
            try {
              localStorage.setItem("pp_is_admin", isAdmin ? "1" : "0");
            } catch (e) {}

            if (isAdmin) {
              window.location.href = "clube-admin.html";
            } else {
              window.location.href = "clube-area.html";
            }
          }
        } catch (err) {
          console.error("Erro no login:", err);
          let msg = "Erro ao entrar. Confira e-mail e senha.";
          if (err.code === "auth/user-not-found" || err.code === "auth/wrong-password") {
            msg = "E-mail ou senha inválidos.";
          }
          mostrarMensagem(loginMensagem, msg);
        } finally {
          btnLogin.disabled = false;
        }
      });

      // ESQUECI MINHA SENHA
      btnEsqueciSenha.addEventListener("click", async () => {
        mostrarMensagem(loginMensagem, "");

        const email = loginEmail.value.trim();
        if (!email) {
          mostrarMensagem(
            loginMensagem,
            "Digite seu e-mail no campo acima e depois clique em 'Esqueci minha senha'."
          );
          return;
        }

        btnEsqueciSenha.disabled = true;
        mostrarMensagem(loginMensagem, "Enviando link de redefinição...", true);

        try {
          await auth.sendPasswordResetEmail(email);
          mostrarMensagem(
            loginMensagem,
            "Se este e-mail estiver cadastrado, você receberá um link para redefinir sua senha.",
            true
          );
        } catch (err) {
          console.error("Erro ao enviar e-mail de redefinição:", err);
          let msg = "Não foi possível enviar o e-mail de redefinição.";
          if (err.code === "auth/invalid-email") {
            msg = "E-mail inválido.";
          }
          mostrarMensagem(loginMensagem, msg);
        } finally {
          btnEsqueciSenha.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
