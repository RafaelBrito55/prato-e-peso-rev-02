<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Clube Prato & Peso – Minha área</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f5f5f7;
      --bg-alt: #ffffff;
      --primary: #1e5a4d;
      --primary-soft: #e0f3ec;
      --accent: #ffb347;
      --text-main: #222222;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
      --radius-xl: 22px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.12);
      --max-width: 1120px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #fff7e6 0, #f5f5f7 45%, #e5e7eb 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* HEADER */
    header {
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .header-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit;
    }

    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #4b2c15;
      font-size: 0.95rem;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
    }

    .logo-text-main {
      font-weight: 800;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.9rem;
      color: #111827;
    }

    .logo-text-sub {
      font-size: 0.78rem;
      color: #6b7280;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .header-link {
      font-size: 0.85rem;
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #ffffff;
      color: #0f172a;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.18s ease-in-out;
    }

    .header-link:hover {
      border-color: #0f766e;
      color: #0f766e;
      box-shadow: 0 6px 16px rgba(15, 118, 110, 0.18);
      transform: translateY(-1px);
    }

    .header-link-cta {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #ffffff;
      border: none;
      font-weight: 600;
    }

    .header-link-cta:hover {
      background: linear-gradient(135deg, #22c55e, #15803d);
      color: #ecfdf5;
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 12px 30px rgba(22, 163, 74, 0.35);
    }

    @media (max-width: 640px) {
      .header-inner {
        padding-inline: 12px;
      }
    }

    main {
      padding: 24px 16px 36px;
    }

    .main-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .hero {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .hero h1 {
      font-size: 1.6rem;
      font-weight: 800;
    }

    .hero-subtitle {
      font-size: 0.92rem;
      color: var(--text-muted);
    }

    .cards-grid {
      display: grid;
      gap: 16px;
    }

    @media (min-width: 720px) {
      .cards-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .card {
      background: var(--bg-alt);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);
      padding: 18px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 700;
    }

    .card-subtitle {
      font-size: 0.84rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .card-badge {
      font-size: 0.78rem;
      background: var(--primary-soft);
      color: var(--primary);
      border-radius: 999px;
      padding: 4px 10px;
      font-weight: 600;
      margin-top: 2px;
    }

    .metrics {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
    }

    .metric-label {
      color: var(--text-muted);
    }

    .metric-value {
      font-weight: 600;
    }

    .peso-wrapper {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 10px;
      align-items: center;
    }

    @media (max-width: 780px) {
      .peso-wrapper {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .peso-main {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .peso-valor {
      font-size: 2rem;
      font-weight: 800;
    }

    .peso-valor span {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-left: 4px;
    }

    .peso-legenda {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .peso-grafico {
      border-radius: 18px;
      border: 1px dashed #d1d5db;
      padding: 8px 10px;
      font-size: 0.8rem;
      color: var(--text-muted);
      min-height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .peso-grafico canvas {
      width: 100%;
      height: 80px;
    }

    .peso-rodape {
      display: flex;
      justify-content: space-between;
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .tdee-resumo {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .tdee-linha {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
    }

    .tdee-linha strong {
      font-weight: 600;
    }

    .tdee-meta-legenda {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .tdee-consumo {
      display: flex;
      justify-content: flex-start;
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .tdee-consumo .metric-badge {
      font-size: 0.78rem;
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
    }

    .tags-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .tag-pill {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 4px 10px;
      font-size: 0.78rem;
      background: #f9fafb;
      white-space: nowrap;
    }

    .tag-pill span {
      color: var(--text-muted);
      margin-right: 3px;
    }

    .tag-pill strong {
      font-weight: 600;
    }

    .lista-simples {
      font-size: 0.88rem;
      display: flex;
      flex-direction: column;
      gap: 3px;
      margin-top: 4px;
    }

    .lista-simples strong {
      font-weight: 600;
    }

    .lista-simples .vazio {
      color: #9ca3af;
    }

    .treino-resumo {
      font-size: 0.88rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }

    .treino-resumo li {
      list-style: none;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 10px 22px rgba(30, 90, 77, 0.55);
      margin-top: 6px;
      text-decoration: none;
    }

    .btn:hover {
      background: #124538;
    }

    .btn-secondary {
      background: #e5efe9;
      color: #065f46;
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: #d1e7dd;
    }

    footer {
      padding: 10px 16px 18px;
      text-align: center;
      font-size: 0.78rem;
      color: #9ca3af;
    }

    @media (max-width: 480px) {
      .card {
        padding: 16px 14px 16px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <a href="clube-area.html" class="logo">
        <div class="logo-badge">PaP</div>
        <div>
          <div class="logo-text-main">Prato &amp; Peso</div>
          <div class="logo-text-sub">Clube Prato &amp; Peso</div>
        </div>
      </a>

      <div class="header-right">
        <a href="clube-perfil.html" class="header-link">Perfil</a>
        <button id="btnLogout" class="header-link header-link-cta">Sair</button>
      </div>
    </div>
  </header>

  <main>
    <div class="main-inner">
      <!-- Saudação -->
      <section class="hero">
        <h1>Olá, Rafael</h1>
      </section>

      <!-- Cards -->
      <section class="cards-grid">
        <!-- Resumo de hoje -->
        <article class="card" id="card-resumo-hoje">
          <h2>Resumo de hoje</h2>
          <p class="card-subtitle">Visão rápida do seu dia em calorias.</p>

          <div class="metrics">
            <div class="metric-row">
              <span class="metric-label">Gasto estimado hoje</span>
              <span class="metric-value"><strong id="resumo-gasto">-- kcal</strong></span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Ingeriu hoje</span>
              <span class="metric-value"><strong id="resumo-ingerido">-- kcal</strong></span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Saldo do dia</span>
              <span class="metric-value"><strong id="resumo-saldo">-- kcal</strong></span>
            </div>
          </div>
        </article>

        <!-- Peso & progresso -->
        <article class="card" id="card-peso-progresso">
          <h2>Peso &amp; progresso</h2>
          <p class="card-subtitle">Seu peso atual e a tendência da meta.</p>

          <div class="peso-wrapper">
            <div class="peso-main">
              <div class="peso-valor" id="peso-atual">--,-- kg</div>
              <p class="peso-legenda" id="peso-variacao7-text">
                Você ainda não registrou seu peso no Clube.
              </p>
              <a href="clube-peso.html" class="btn btn-secondary">Ver e registrar peso</a>
            </div>
            <div class="peso-grafico">
              <canvas id="mini-grafico-peso"></canvas>
            </div>
          </div>
          <div class="peso-rodape">
            <span>Últimos 7 registros</span>
          </div>
        </article>

        <!-- Meu TDEE & Meta -->
        <article class="card">
          <h2>Meu TDEE &amp; Meta</h2>
          <p class="card-subtitle">
            Resumo do gasto calórico diário e da meta.
          </p>

          <div class="tdee-resumo">
            <div class="tdee-linha">
              <span>TDEE atual</span>
              <strong id="tdee-atual">-- kcal/dia</strong>
            </div>
            <div class="tdee-linha">
              <span>Objetivo</span>
              <strong id="tdee-meta-descricao">Nenhum cálculo salvo ainda.</strong>
            </div>
          </div>

          <p class="tdee-meta-legenda">
            Defina sua meta de emagrecimento ou ganho de peso e acompanhe aqui.
          </p>

          <div class="tdee-consumo">
            <span class="metric-badge" id="tdee-consumo-resumo">
              Consumo total hoje: — kcal
            </span>
          </div>

          <a href="clube-tdee.html" class="btn btn-secondary">
            Ver detalhes da meta
          </a>
        </article>

        <!-- Minhas medidas corporais -->
        <article class="card">
          <h2>Minhas medidas corporais</h2>
          <p class="card-subtitle">
            Acompanhe as principais medidas do seu corpo.
          </p>

          <div class="tags-grid" id="medidas-resumo">
            <div class="tag-pill">
              <span>Pescoço</span>
              <strong id="medida-pescoco">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Ombro</span>
              <strong id="medida-ombro">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Peito</span>
              <strong id="medida-peito">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Cintura</span>
              <strong id="medida-cintura">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Abd. sup.</span>
              <strong id="medida-abd-sup">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Abd. inf.</span>
              <strong id="medida-abd-inf">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Braço esq.</span>
              <strong id="medida-braco-e">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Braço dir.</span>
              <strong id="medida-braco-d">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Antebraço esq.</span>
              <strong id="medida-antebraco-e">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Antebraço dir.</span>
              <strong id="medida-antebraco-d">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Coxa esq.</span>
              <strong id="medida-coxa-e">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Coxa dir.</span>
              <strong id="medida-coxa-d">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Pant. esq.</span>
              <strong id="medida-pant-e">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Pant. dir.</span>
              <strong id="medida-pant-d">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Quadril</span>
              <strong id="medida-quadril">-- cm</strong>
            </div>
          </div>

          <p class="tdee-meta-legenda" id="medidas-legenda">
            Você ainda não registrou suas medidas corporais.
          </p>

          <a href="clube-medidas.html" class="btn btn-secondary">
            Registrar / atualizar medidas
          </a>
        </article>

        <!-- Montar prato brasileiro -->
        <article class="card">
          <h2>Montar prato brasileiro</h2>
          <p class="card-subtitle">
            Você ainda não registrou um prato no Clube.
          </p>

          <div class="lista-simples">
            <div>
              <strong>Último prato registrado em</strong>
              <span id="prato-data">—</span>
            </div>
            <div>
              <strong>Consumo total hoje</strong>
              <span id="prato-calorias">—</span>
            </div>
          </div>

          <p class="tdee-meta-legenda" id="card-prato-subtitle">
            Monte o prato do dia e veja a soma em kcal.
          </p>

          <a href="clube-prato.html" class="btn">
            Montar / atualizar prato de hoje
          </a>
        </article>

        <!-- Treino de hoje / Academia -->
        <article class="card">
          <h2>Treino de hoje / Academia</h2>
          <p class="card-subtitle">
            Últimos pesos para você lembrar na próxima sessão.
          </p>

          <ul class="treino-resumo">
            <li id="treino-ultimo">
              <strong>Último treino:</strong> nenhum treino registrado ainda.
            </li>
            <li id="treino-ex1" style="display:none;"></li>
            <li id="treino-ex2" style="display:none;"></li>
          </ul>

          <a href="clube-treino.html" class="btn btn-secondary">
            Registrar treino de hoje
          </a>
        </article>

        <!-- NOVO CARD: Relatório do período -->
        <article class="card">
          <h2>Relatório do período</h2>
          <p class="card-subtitle">
            Gere um relatório com peso, calorias e medidas corporais em um intervalo de datas.
          </p>

          <div class="lista-simples">
            <span>
              Use esta opção quando quiser analisar uma semana, mês ou outro período com mais detalhes.
            </span>
          </div>

          <a href="relatorio.html" class="btn btn-secondary">
            Abrir relatório simples
          </a>
        </article>
      </section>
    </div>
  </main>

  <footer>
    © 2025 Prato &amp; Peso – Área do Clube.
  </footer>

  <!-- Firebase + Chart.js -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyABfAWUAW6a6g93B9QKooTKd5Mj645G3vE",
      authDomain: "prato-e-peso-77b5a.firebaseapp.com",
      projectId: "prato-e-peso-77b5a",
      storageBucket: "prato-e-peso-77b5a.appspot.com",
      messagingSenderId: "432109202072",
      appId: "1:432109202072:web:1c8636db0c161318ddfeed"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db   = firebase.firestore();

    /* ---------- Logout ---------- */
    function limparLocalStorageClube() {
      try {
        localStorage.removeItem("pp_user_uid");
        localStorage.removeItem("pp_user_email");
        localStorage.removeItem("pp_user_nome");
        localStorage.removeItem("pp_plano_codigo");
        localStorage.removeItem("pp_plano_nome");
      } catch (e) {
        console.warn("Não foi possível limpar localStorage do Clube:", e);
      }
    }

    function fazerLogout() {
      auth.signOut().finally(() => {
        limparLocalStorageClube();
        window.location.href = "clube-login.html";
      });
    }

    document.getElementById("btnLogout")?.addEventListener("click", fazerLogout);

    /* ---------- Helpers ---------- */
    function formatarDataBR(dataISO) {
      if (!dataISO) return "";
      const partes = dataISO.split("-");
      if (partes.length !== 3) return dataISO;
      const [ano, mes, dia] = partes;
      return `${dia}/${mes}`;
    }

    function formatarNumero(valor, casas) {
      if (valor === null || valor === undefined || isNaN(valor)) return "—";
      return Number(valor).toLocaleString("pt-BR", {
        minimumFractionDigits: casas,
        maximumFractionDigits: casas
      });
    }

    /* ---------- Referências DOM ---------- */
    // prato
    const pratoDataSpan     = document.getElementById("prato-data");
    const pratoCaloriasSpan = document.getElementById("prato-calorias");
    const pratoSubtitle     = document.getElementById("card-prato-subtitle");

    // peso
    const pesoAtualSpan     = document.getElementById("peso-atual");
    const pesoVariacao7Text = document.getElementById("peso-variacao7-text");
    let graficoPesoMini     = null;

    // TDEE
    const tdeeAtualSpan     = document.getElementById("tdee-atual");
    const tdeeMetaDescricao = document.getElementById("tdee-meta-descricao");
    const tdeeConsumoResumo = document.getElementById("tdee-consumo-resumo");
    let consumoTotalHojeFmt = "— kcal";       // texto do consumo do prato
    let consumoTotalHojeNumero = null;        // número de kcal ingeridas hoje
    let tdeeValorAtualNumero   = null;        // número de kcal de gasto estimado

    // Resumo de hoje
    const resumoGastoSpan    = document.getElementById("resumo-gasto");
    const resumoIngeridoSpan = document.getElementById("resumo-ingerido");
    const resumoSaldoSpan    = document.getElementById("resumo-saldo");

    // medidas
    const medidaPescocoSpan    = document.getElementById("medida-pescoco");
    const medidaOmbroSpan      = document.getElementById("medida-ombro");
    const medidaPeitoSpan      = document.getElementById("medida-peito");
    const medidaCinturaSpan    = document.getElementById("medida-cintura");
    const medidaAbdSupSpan     = document.getElementById("medida-abd-sup");
    const medidaAbdInfSpan     = document.getElementById("medida-abd-inf");
    const medidaBracoESpan     = document.getElementById("medida-braco-e");
    const medidaBracoDSpan     = document.getElementById("medida-braco-d");
    const medidaAntebracoESpan = document.getElementById("medida-antebraco-e");
    const medidaAntebracoDSpan = document.getElementById("medida-antebraco-d");
    const medidaCoxaESpan      = document.getElementById("medida-coxa-e");
    const medidaCoxaDSpan      = document.getElementById("medida-coxa-d");
    const medidaPantESpan      = document.getElementById("medida-pant-e");
    const medidaPantDSpan      = document.getElementById("medida-pant-d");
    const medidaQuadrilSpan    = document.getElementById("medida-quadril");
    const medidasLegenda       = document.getElementById("medidas-legenda");

    // treino
    const treinoUltimoLi = document.getElementById("treino-ultimo");
    const treinoEx1Li    = document.getElementById("treino-ex1");
    const treinoEx2Li    = document.getElementById("treino-ex2");

    /* ---------- Consumo / prato ---------- */
    function atualizarTdeeConsumoResumo() {
      if (tdeeConsumoResumo) {
        tdeeConsumoResumo.textContent = "Consumo total hoje: " + consumoTotalHojeFmt;
      }
    }

    // Atualiza o card "Resumo de hoje" usando TDEE + consumo do dia
    function atualizarResumoDia() {
      if (!resumoGastoSpan || !resumoIngeridoSpan || !resumoSaldoSpan) return;

      // Gasto estimado (TDEE)
      if (tdeeValorAtualNumero !== null) {
        resumoGastoSpan.textContent =
          Math.round(tdeeValorAtualNumero).toLocaleString("pt-BR") + " kcal";
      } else {
        resumoGastoSpan.textContent = "-- kcal";
      }

      // Ingeriu hoje (consumo do prato / consumo diário)
      if (consumoTotalHojeNumero !== null) {
        resumoIngeridoSpan.textContent =
          Math.round(consumoTotalHojeNumero).toLocaleString("pt-BR") + " kcal";
      } else {
        resumoIngeridoSpan.textContent = "-- kcal";
      }

      // Saldo do dia = ingerido - gasto (déficit negativo, superávit positivo)
      if (tdeeValorAtualNumero !== null && consumoTotalHojeNumero !== null) {
        const saldo    = consumoTotalHojeNumero - tdeeValorAtualNumero;
        const saldoAbs = Math.abs(Math.round(saldo)).toLocaleString("pt-BR");
        let texto = "";
        let cor   = "#6b7280";

        if (saldo < 0) {
          texto = "– " + saldoAbs + " kcal";
          cor   = "#16a34a";
        } else if (saldo > 0) {
          texto = "+ " + saldoAbs + " kcal";
          cor   = "#b91c1c";
        } else {
          texto = "0 kcal";
          cor   = "#6b7280";
        }

        resumoSaldoSpan.textContent = texto;
        resumoSaldoSpan.style.color = cor;
      } else {
        resumoSaldoSpan.textContent = "-- kcal";
        resumoSaldoSpan.style.color = "#6b7280";
      }
    }

    async function carregarResumoPrato(uid) {
      if (!pratoDataSpan || !pratoCaloriasSpan) return;

      pratoDataSpan.textContent     = "carregando...";
      pratoCaloriasSpan.textContent = "carregando...";
      consumoTotalHojeFmt           = "— kcal";
      consumoTotalHojeNumero        = null;
      atualizarTdeeConsumoResumo();
      atualizarResumoDia();

      try {
        const snapshot = await db
          .collection("consumosDiarios")
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          pratoDataSpan.textContent     = "—";
          pratoCaloriasSpan.textContent = "—";
          consumoTotalHojeFmt           = "— kcal";
          consumoTotalHojeNumero        = null;
          atualizarTdeeConsumoResumo();
          atualizarResumoDia();
          if (pratoSubtitle) {
            pratoSubtitle.textContent = "Você ainda não registrou um prato no Clube.";
          }
          return;
        }

        const docs = snapshot.docs.slice();
        docs.sort((a, b) => {
          const da = a.data().data || "";
          const dbb = b.data().data || "";
          if (da < dbb) return 1;
          if (da > dbb) return -1;
          return 0;
        });

        const dados   = docs[0].data();
        const dataISO = dados.data;
        const dataBR  = formatarDataBR(dataISO);

        const caloriasRaw = Number(dados.caloriasTotais || dados.calorias);
        const caloriasFmt =
          !isNaN(caloriasRaw) && caloriasRaw > 0
            ? Math.round(caloriasRaw).toLocaleString("pt-BR") + " kcal"
            : "—";

        pratoDataSpan.textContent     = dataBR || "—";
        pratoCaloriasSpan.textContent = caloriasFmt;

        consumoTotalHojeFmt    = caloriasFmt;
        consumoTotalHojeNumero = !isNaN(caloriasRaw) && caloriasRaw > 0 ? caloriasRaw : null;
        atualizarTdeeConsumoResumo();
        atualizarResumoDia();

        if (pratoSubtitle) {
          pratoSubtitle.textContent = "Resumo do último prato registrado no Clube.";
        }
      } catch (err) {
        console.error("Erro ao carregar dados de prato:", err);
        pratoDataSpan.textContent     = "—";
        pratoCaloriasSpan.textContent = "—";
        consumoTotalHojeFmt           = "— kcal";
        consumoTotalHojeNumero        = null;
        atualizarTdeeConsumoResumo();
        atualizarResumoDia();
        if (pratoSubtitle) {
          pratoSubtitle.textContent = "Não foi possível carregar seus pratos agora.";
        }
      }
    }

    /* ---------- Peso & gráfico mini ---------- */
    async function carregarPesoEProgresso(uid) {
      if (!pesoAtualSpan || !pesoVariacao7Text) return;

      pesoAtualSpan.textContent     = "--,-- kg";
      pesoVariacao7Text.textContent = "Carregando dados de peso...";

      try {
        const snapshot = await db
          .collection("pesos")
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          pesoVariacao7Text.textContent = "Você ainda não registrou seu peso no Clube.";
          return;
        }

        const docs = snapshot.docs.slice();
        docs.sort((a, b) => {
          const da = a.data().data || "";
          const dbb = b.data().data || "";
          if (da < dbb) return -1;
          if (da > dbb) return 1;
          return 0;
        });

        const dadosOrdenados = docs.map((doc) => doc.data());
        const ultimo         = dadosOrdenados[dadosOrdenados.length - 1];
        const pesoAtual      = ultimo.peso;

        pesoAtualSpan.textContent = formatarNumero(pesoAtual, 1) + " kg";

        // mini gráfico (últimos 7)
        const ultimos7 = dadosOrdenados.slice(-7);
        const labels   = ultimos7.map((d) => formatarDataBR(d.data));
        const dados    = ultimos7.map((d) => d.peso);

        const canvas = document.getElementById("mini-grafico-peso");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");

        if (graficoPesoMini) {
          graficoPesoMini.destroy();
          graficoPesoMini = null;
        }

        graficoPesoMini = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Peso (kg)",
                data: dados,
                borderColor: "rgba(22,163,74,1)",
                backgroundColor: "rgba(187,247,208,0.45)",
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 4,
                pointBackgroundColor: "rgba(22,163,74,1)",
                pointBorderColor: "#ffffff",
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const v = ctx.parsed.y;
                    return formatarNumero(v, 1) + " kg";
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { display: false }
              },
              y: {
                grid: { display: false },
                ticks: {
                  callback: (value) => formatarNumero(value, 0) + " kg"
                }
              }
            }
          }
        });

        if (ultimos7.length >= 2) {
          const primeiro = ultimos7[0].peso;
          const ultimoP  = ultimos7[ultimos7.length - 1].peso;
          const diff7    = ultimoP - primeiro;
          const diffAbsFmt = formatarNumero(Math.abs(diff7), 1);

          if (diff7 < 0) {
            pesoVariacao7Text.textContent =
              `Nos últimos ${ultimos7.length} registros: — ${diffAbsFmt} kg`;
            pesoVariacao7Text.style.color = "#16a34a";
          } else if (diff7 > 0) {
            pesoVariacao7Text.textContent =
              `Nos últimos ${ultimos7.length} registros: + ${diffAbsFmt} kg`;
            pesoVariacao7Text.style.color = "#b91c1c";
          } else {
            pesoVariacao7Text.textContent =
              `Nos últimos ${ultimos7.length} registros: 0,0 kg de variação`;
            pesoVariacao7Text.style.color = "#6b7280";
          }
        } else {
          pesoVariacao7Text.textContent =
            "Aguardando mais registros para calcular a variação.";
          pesoVariacao7Text.style.color = "#6b7280";
        }
      } catch (err) {
        console.error("Erro ao carregar peso/progresso:", err);
        pesoVariacao7Text.textContent = "Não foi possível carregar os dados de peso.";
        pesoVariacao7Text.style.color = "#b91c1c";
      }
    }

    /* ---------- TDEE ---------- */
    async function carregarResumoTdee(uid) {
      if (!tdeeAtualSpan || !tdeeMetaDescricao) return;

      tdeeAtualSpan.textContent     = "-- kcal/dia";
      tdeeMetaDescricao.textContent = "Carregando dados da meta...";

      try {
        const snapshot = await db
          .collection("tdee")
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          tdeeMetaDescricao.textContent = "Nenhum cálculo salvo ainda.";
          tdeeValorAtualNumero = null;
          atualizarResumoDia();
          return;
        }

        const docs = snapshot.docs.slice();
        const getMillis = (doc) => {
          const v = doc.data().atualizadoEm;
          if (!v || typeof v.toMillis !== "function") return 0;
          return v.toMillis();
        };
        docs.sort((a, b) => getMillis(b) - getMillis(a));

        const dados       = docs[0].data();
        const tdee        = Number(dados.tdee);
        const metaCalorias = Number(dados.metaCalorias);
        const metaTipo    = dados.metaTipo || "Meta";

        const tdeeFmt = !isNaN(tdee)
          ? Math.round(tdee).toLocaleString("pt-BR") + " kcal/dia"
          : "-- kcal/dia";
        const metaFmt = !isNaN(metaCalorias)
          ? Math.round(metaCalorias).toLocaleString("pt-BR") + " kcal/dia"
          : "— kcal/dia";

        tdeeAtualSpan.textContent     = tdeeFmt;
        tdeeMetaDescricao.textContent = `${metaTipo} – meta ${metaFmt}`;

        // guarda valor numérico para o resumo do dia
        tdeeValorAtualNumero = !isNaN(tdee) && tdee > 0 ? tdee : null;
        atualizarResumoDia();
      } catch (err) {
        console.error("Erro ao carregar resumo de TDEE:", err);
        tdeeMetaDescricao.textContent = "Não foi possível carregar seu TDEE agora.";
        tdeeValorAtualNumero = null;
        atualizarResumoDia();
      }
    }

    /* ---------- Medidas corporais ---------- */
    async function carregarResumoMedidas(uid) {
      const spans = [
        medidaPescocoSpan, medidaOmbroSpan, medidaPeitoSpan,
        medidaCinturaSpan, medidaAbdSupSpan, medidaAbdInfSpan,
        medidaBracoESpan, medidaBracoDSpan,
        medidaAntebracoESpan, medidaAntebracoDSpan,
        medidaCoxaESpan, medidaCoxaDSpan,
        medidaPantESpan, medidaPantDSpan,
        medidaQuadrilSpan
      ];

      const reset = () => {
        spans.forEach((el) => {
          if (el) {
            el.textContent = "-- cm";
            el.style.color = "#9ca3af";
          }
        });
        if (medidasLegenda) {
          medidasLegenda.textContent = "Você ainda não registrou suas medidas corporais.";
          medidasLegenda.style.color = "#6b7280";
        }
      };

      if (!spans.length) return;
      reset();
      if (medidasLegenda) {
        medidasLegenda.textContent = "Carregando últimas medidas...";
        medidasLegenda.style.color = "#6b7280";
      }

      try {
        const snapshot = await db
          .collection("medidasCorporais")
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          reset();
          return;
        }

        const docs = snapshot.docs.slice();
        const getMillis = (doc) => {
          const v = doc.data().dataRegistro;
          if (!v || typeof v.toMillis !== "function") return 0;
          return v.toMillis();
        };
        docs.sort((a, b) => getMillis(b) - getMillis(a));

        const dados = docs[0].data();

        const mapa = [
          [medidaPescocoSpan, dados.pescoco],
          [medidaOmbroSpan, dados.ombro],
          [medidaPeitoSpan, dados.peito],
          [medidaCinturaSpan, dados.cintura],
          [medidaAbdSupSpan, dados.abdSup],
          [medidaAbdInfSpan, dados.abdInf],
          [medidaBracoESpan, dados.bracoEsq],
          [medidaBracoDSpan, dados.bracoDir],
          [medidaAntebracoESpan, dados.antebracoEsq],
          [medidaAntebracoDSpan, dados.antebracoDir],
          [medidaCoxaESpan, dados.coxaEsq],
          [medidaCoxaDSpan, dados.coxaDir],
          [medidaPantESpan, dados.panturrilhaEsq],
          [medidaPantDSpan, dados.panturrilhaDir],
          [medidaQuadrilSpan, dados.quadril]
        ];

        mapa.forEach(([el, valor]) => {
          if (!el) return;
          if (valor !== undefined && valor !== null && valor !== "") {
            el.textContent = formatarNumero(valor, 1) + " cm";
            el.style.color = "#111827";
          } else {
            el.textContent = "-- cm";
            el.style.color = "#9ca3af";
          }
        });

        if (medidasLegenda) {
          const dataBR = dados.data ? formatarDataBR(dados.data) : "";
          medidasLegenda.textContent =
            dataBR
              ? `Última atualização em ${dataBR}.`
              : "Última atualização registrada.";
          medidasLegenda.style.color = "#6b7280";
        }
      } catch (err) {
        console.error("Erro ao carregar resumo de medidas:", err);
        reset();
        if (medidasLegenda) {
          medidasLegenda.textContent =
            "Não foi possível carregar suas medidas agora.";
          medidasLegenda.style.color = "#b91c1c";
        }
      }
    }

    /* ---------- Treino – resumo ---------- */
    async function carregarResumoTreino(uid) {
      if (!treinoUltimoLi) return;

      treinoUltimoLi.innerHTML =
        "<strong>Último treino:</strong> carregando...";
      treinoEx1Li.style.display = "none";
      treinoEx2Li.style.display = "none";

      try {
        const snapshot = await db
          .collection("treinosDiarios")
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          treinoUltimoLi.innerHTML =
            "<strong>Último treino:</strong> nenhum treino registrado ainda.";
          return;
        }

        const docs = snapshot.docs.slice();
        docs.sort((a, b) => {
          const da = a.data().dataTreino || "";
          const dbb = b.data().dataTreino || "";
          if (da < dbb) return 1;
          if (da > dbb) return -1;
          return 0;
        });

        const dados = docs[0].data();
        const dataBR =
          dados.dataTreino ? formatarDataBR(dados.dataTreino) : "—";
        const nomeTreino = dados.nomeTreino || "Treino";

        treinoUltimoLi.innerHTML =
          `<strong>Último treino:</strong> ${dataBR} – ${nomeTreino}`;

        const exs = Array.isArray(dados.exercicios) ? dados.exercicios : [];
        if (exs.length > 0) {
          treinoEx1Li.style.display = "list-item";
          treinoEx1Li.textContent =
            `${exs[0].nome} – ${exs[0].pesoKg || exs[0].peso || "--"} kg`;
        }
        if (exs.length > 1) {
          treinoEx2Li.style.display = "list-item";
          treinoEx2Li.textContent =
            `${exs[1].nome} – ${exs[1].pesoKg || exs[1].peso || "--"} kg`;
        }
      } catch (err) {
        console.error("Erro ao carregar resumo de treino:", err);
        treinoUltimoLi.innerHTML =
          "<strong>Último treino:</strong> não foi possível carregar os dados.";
        treinoEx1Li.style.display = "none";
        treinoEx2Li.style.display = "none";
      }
    }

    /* ---------- Auth / inicialização ---------- */
    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "clube-login.html";
        return;
      }

      const uid = user.uid;

      carregarResumoPrato(uid);
      carregarPesoEProgresso(uid);
      carregarResumoTdee(uid);
      carregarResumoMedidas(uid);
      carregarResumoTreino(uid);
    });
  </script>
</body>
</html>
