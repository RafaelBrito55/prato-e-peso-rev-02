<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Clube Prato & Peso ‚Äì Minha √°rea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f5f5f7;
      --bg-alt: #ffffff;
      --primary: #1e5a4d;
      --primary-soft: #e0f3ec;
      --accent: #ffb347;
      --accent-soft: #fff3df;
      --text-main: #222222;
      --text-muted: #666666;
      --border-soft: #e0e0e0;
      --radius-lg: 16px;
      --radius-xl: 22px;
      --shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.08);
      --max-width: 1040px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf5ea 0, #f5f5f7 45%, #f0f2f5 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    header {
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #4b2c15;
      font-size: 0.9rem;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.1);
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .logo-text-main {
      font-weight: 700;
      font-size: 0.98rem;
      letter-spacing: 0.03em;
    }

    .logo-text-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .user-greeting {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .header-pill {
      font-size: 0.8rem;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f5f5f7;
      cursor: pointer;
      white-space: nowrap;
    }

    .header-pill-primary {
      background: var(--primary);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
    }

    main {
      flex: 1;
      padding: 24px 16px 40px;
    }

    .main-inner {
      max-width: var(--max-width);
      margin: 0 auto;
    }

    .card {
      background: var(--bg-alt);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);
      padding: 18px 16px;
      margin-bottom: 18px;
    }

    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    .card small {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .highlight {
      background: #ffedd5;
      color: #7c2d12;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
    }

    .resumo-lista {
      list-style: none;
      margin-top: 8px;
      padding-left: 0;
      font-size: 0.9rem;
    }

    .resumo-lista li + li {
      margin-top: 4px;
    }

    .resumo-lista span {
      color: var(--text-muted);
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-top: 12px;
      margin-bottom: 4px;
    }

    input[type="date"],
    input[type="number"],
    input[type="text"],
    input[type="email"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      box-sizing: border-box;
      background: #f9fafb;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary-soft);
      background: #ffffff;
    }

    button.primary {
      margin-top: 14px;
      background: var(--primary);
      color: #ffffff;
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.18);
    }

    button.secondary {
      margin-top: 12px;
      background: #e5e7eb;
      color: #111827;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    button.danger {
      margin-top: 12px;
      background: #dc2626;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }

    .col {
      flex: 1;
      min-width: 140px;
    }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
      display: none;
    }

    .message.ok {
      color: #15803d;
    }

    .message.error {
      color: #b91c1c;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.85rem;
    }

    th,
    td {
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      padding: 6px 4px;
      text-align: left;
    }

    th {
      font-weight: 600;
      color: #4b5563;
    }

    td {
      color: #111827;
    }

    tfoot td {
      border-top: 1px solid rgba(148, 163, 184, 0.7);
      font-weight: 600;
    }

    footer {
      background: #111111;
      color: #d0d0d0;
      font-size: 0.78rem;
      padding: 12px 16px 16px;
      margin-top: 12px;
    }

    .footer-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      text-align: center;
    }

    .footer-note {
      color: #aaaaaa;
      line-height: 1.5;
    }

    /* MODAL do perfil */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: var(--bg-alt);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);
      max-width: 480px;
      width: calc(100% - 32px);
      padding: 18px 16px 20px;
      position: relative;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .modal-header h2 {
      font-size: 1.1rem;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 1.4rem;
      line-height: 1;
      cursor: pointer;
      color: var(--text-muted);
    }

    /* GRID das medidas corporais (2 em 2 cards) */
    .medidas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .medida-item {
      background: #f9fafb;
      border-radius: var(--radius-lg);
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      font-size: 0.85rem;
    }

    .medida-label {
      font-size: 0.78rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 2px;
    }

    .medida-item strong {
      font-size: 1rem;
    }

    @media (max-width: 640px) {
      .header-inner {
        padding-inline: 10px;
      }

      main {
        padding-inline: 12px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <!-- Logo -->
      <a href="index.html" class="logo">
        <div class="logo-badge">P&amp;P</div>
        <div class="logo-text">
          <div class="logo-text-main">Prato &amp; Peso</div>
          <div class="logo-text-sub">Comida de verdade, meta clara</div>
        </div>
      </a>

      <!-- Ordem: Ol√° usu√°rio ‚Ä¢ Perfil ‚Ä¢ Sair -->
      <div class="header-right">
        <span id="userGreeting" class="user-greeting">Carregando...</span>
        <button id="btnOpenPerfil" class="header-pill">Perfil</button>
        <button id="btnLogout" class="header-pill header-pill-primary">Sair</button>
      </div>
    </div>
  </header>

  <main>
    <div class="main-inner">
      <!-- RESUMO R√ÅPIDO -->
      <section class="card" id="cardResumo">
        <h2>Resumo r√°pido</h2>
        <div id="resumoConteudo">
          <small>Buscando seus dados...</small>
        </div>
      </section>

      <!-- MEU PESO -->
      <section class="card" id="cardPeso">
        <h2>Meu peso</h2>
        <small>Registre seu peso e acompanhe a evolu√ß√£o ao longo do tempo.</small>

        <div class="row">
          <div class="col">
            <label for="pesoData">Data</label>
            <input type="date" id="pesoData" />
          </div>
          <div class="col">
            <label for="pesoValor">Peso (kg)</label>
            <input type="number" id="pesoValor" step="0.1" min="0" />
          </div>
        </div>

        <button class="primary" id="btnSalvarPeso">Salvar peso</button>
        <div id="pesoMessage" class="message"></div>

        <table id="tabelaPesos">
          <thead>
            <tr>
              <th>Data</th>
              <th>Peso (kg)</th>
            </tr>
          </thead>
          <tbody id="listaPesos"></tbody>
        </table>
      </section>

      <!-- MEU TDEE (CLUBE) -->
      <section class="card" id="cardTDEE">
        <h2>Meu TDEE</h2>
        <small>Resumo do seu gasto cal√≥rico di√°rio estimado e da meta de emagrecimento.</small>

        <div id="tdeeConteudo" style="margin-top:8px;">
          <small>Buscando seu TDEE...</small>
        </div>

        <button class="secondary" type="button" onclick="window.location.href='clube-tdee.html'">
          Abrir calculadora de TDEE do Clube
        </button>
      </section>

      <!-- MINHAS MEDIDAS CORPORAIS (CLUBE) -->
      <section class="card" id="cardMedidas">
        <h2>Minhas medidas corporais</h2>
        <small>Acompanhe as principais medidas do seu corpo, como cintura, abd√¥men, bra√ßos e pernas.</small>

        <div id="medidasConteudo" style="margin-top:8px;">
          <small>Buscando suas medidas...</small>
        </div>

        <button class="secondary" type="button" onclick="window.location.href='clube-medidas.html'">
          Registrar / atualizar medidas (Clube)
        </button>
      </section>

      <!-- MONTAR PRATO BRASILEIRO (CLUBE) -->
      <section class="card" id="cardPratoBrasileiro">
        <h2>Montar prato brasileiro</h2>
        <small>Veja um resumo do √∫ltimo prato cadastrado e das calorias do dia.</small>

        <div id="pratoConteudo" style="margin-top:8px;">
          <small>Buscando seus pratos...</small>
        </div>

        <button class="secondary" type="button" onclick="window.location.href='clube-prato.html'">
          Montar um novo prato (Clube)
        </button>
      </section>

      <!-- RELAT√ìRIO -->
      <section class="card" id="cardRelatorio">
        <h2>Relat√≥rio simples</h2>
        <small>Gere um relat√≥rio organizado usando os dados do Clube.</small>

        <p style="margin-top:8px; font-size:0.9rem; color:var(--text-muted);">
          Voc√™ pode escolher um per√≠odo e ver um resumo da evolu√ß√£o de peso, medidas e das calorias.
          O relat√≥rio abre em outra tela, exclusiva para membros do Clube.
        </p>

        <button class="primary" type="button" onclick="window.location.href='relatorio.html'">
          Abrir relat√≥rio do meu per√≠odo
        </button>
      </section>
    </div>
  </main>

  <!-- MODAL PERFIL -->
  <div id="perfilModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>Meu perfil</h2>
        <button id="btnFecharPerfil" class="modal-close" aria-label="Fechar">√ó</button>
      </div>
      <small>Atualize seus dados b√°sicos e gerencie sua conta.</small>

      <label for="perfilNome">Nome</label>
      <input type="text" id="perfilNome" placeholder="Seu nome" />

      <label for="perfilEmail">E-mail (n√£o edit√°vel)</label>
      <input type="email" id="perfilEmail" disabled />

      <label for="perfilDataNascimento">Data de nascimento</label>
      <input type="date" id="perfilDataNascimento" />

      <button class="primary" id="btnSalvarPerfil">Salvar altera√ß√µes</button>
      <div id="perfilMessage" class="message"></div>

      <hr style="margin: 16px 0;" />

      <h3 style="margin-bottom:6px; font-size:1rem; color:#b91c1c;">Excluir minha conta</h3>
      <small style="display:block; margin-bottom:8px; color:var(--text-muted);">
        Essa a√ß√£o √© <strong>definitiva</strong>. Seus dados de pesos, pratos e acesso ao Clube ser√£o apagados.
      </small>
      <button class="danger" id="btnExcluirConta">Excluir minha conta</button>
      <div id="excluirMessage" class="message"></div>
    </div>
  </div>

  <footer>
    <div class="footer-inner">
      <div class="footer-note">
        Dados do Clube armazenados com carinho para voc√™ acompanhar sua evolu√ß√£o.
      </div>
      <div style="font-size:0.75rem; color:#888888;">
        ¬© <span id="anoAtual"></span> Prato &amp; Peso. Todos os direitos reservados.
      </div>
    </div>
  </footer>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyABfAWUAW6a6g93B9QKooTKd5Mj645G3vE",
      authDomain: "prato-e-peso-77b5a.firebaseapp.com",
      projectId: "prato-e-peso-77b5a",
      storageBucket: "prato-e-peso-77b5a.firebasestorage.app",
      messagingSenderId: "432109202072",
      appId: "1:432109202072:web:1c8636db0c161318ddfeed"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const userGreeting = document.getElementById("userGreeting");
    const btnLogout = document.getElementById("btnLogout");
    const btnOpenPerfil = document.getElementById("btnOpenPerfil");
    const perfilModal = document.getElementById("perfilModal");
    const btnFecharPerfil = document.getElementById("btnFecharPerfil");

    const pesoDataInput = document.getElementById("pesoData");
    const pesoValorInput = document.getElementById("pesoValor");
    const btnSalvarPeso = document.getElementById("btnSalvarPeso");
    const pesoMessage = document.getElementById("pesoMessage");
    const listaPesos = document.getElementById("listaPesos");
    const resumoConteudo = document.getElementById("resumoConteudo");

    const perfilNomeInput = document.getElementById("perfilNome");
    const perfilEmailInput = document.getElementById("perfilEmail");
    const perfilDataNascimentoInput = document.getElementById("perfilDataNascimento");
    const btnSalvarPerfil = document.getElementById("btnSalvarPerfil");
    const perfilMessage = document.getElementById("perfilMessage");

    const btnExcluirConta = document.getElementById("btnExcluirConta");
    const excluirMessage = document.getElementById("excluirMessage");

    const tdeeConteudo = document.getElementById("tdeeConteudo");
    const pratoConteudo = document.getElementById("pratoConteudo");
    const medidasConteudo = document.getElementById("medidasConteudo");

    let currentUser = null;
    let currentUid = null;

    function setHojeNoCampoPeso() {
      const hoje = new Date();
      const yyyy = hoje.getFullYear();
      const mm = String(hoje.getMonth() + 1).padStart(2, "0");
      const dd = String(hoje.getDate()).padStart(2, "0");
      pesoDataInput.value = `${yyyy}-${mm}-${dd}`;
    }

    function mostrarMensagem(el, texto, tipo) {
      if (!el) return;
      el.style.display = texto ? "block" : "none";
      el.textContent = texto || "";
      el.classList.remove("ok", "error");
      if (tipo === "ok") el.classList.add("ok");
      if (tipo === "error") el.classList.add("error");
    }

    function limparLocalStorageClube() {
      try {
        localStorage.removeItem("pp_user_uid");
        localStorage.removeItem("pp_user_email");
        localStorage.removeItem("pp_user_nome");
        localStorage.removeItem("pp_plano_codigo");
        localStorage.removeItem("pp_plano_nome");
      } catch (e) {
        console.warn("N√£o foi poss√≠vel limpar localStorage do Clube:", e);
      }
    }

    // ===== PESOS & RESUMO =====
    async function carregarPesos(uid) {
      listaPesos.innerHTML = "";
      resumoConteudo.innerHTML = "<small>Buscando seus dados...</small>";

      try {
        const snapshot = await db
          .collection("pesos")
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          resumoConteudo.innerHTML = `
            <p>Ainda n√£o h√° registros de peso.</p>
            <small>Comece registrando seu primeiro peso no card <span class="highlight">Meu peso</span>.</small>
          `;
          return;
        }

        const docs = snapshot.docs.slice();

        // ordena manualmente pela data (string "AAAA-MM-DD") desc
        docs.sort((a, b) => {
          const da = (a.data().data || "");
          const dbb = (b.data().data || "");
          if (da < dbb) return 1;
          if (da > dbb) return -1;
          return 0;
        });

        const limitados = docs.slice(0, 30);
        let ultimoPesoDoc = null;

        limitados.forEach((doc, index) => {
          const dados = doc.data();
          adicionarLinhaPeso(dados.data, dados.peso);
          if (index === 0) ultimoPesoDoc = doc;
        });

        await montarResumoGeral(uid, docs, ultimoPesoDoc);
      } catch (err) {
        console.error("Erro ao carregar pesos:", err);
        resumoConteudo.innerHTML = `
          <p>N√£o foi poss√≠vel carregar seu hist√≥rico de peso.</p>
          <small>Tente novamente em alguns instantes.</small>
        `;
      }
    }

    function adicionarLinhaPeso(dataISO, peso) {
      const tr = document.createElement("tr");
      const tdData = document.createElement("td");
      const tdPeso = document.createElement("td");

      const dataFormatada = formatarDataBR(dataISO);

      tdData.textContent = dataFormatada;
      tdPeso.textContent = Number(peso).toLocaleString("pt-BR", {
        minimumFractionDigits: 1,
        maximumFractionDigits: 1
      });

      tr.appendChild(tdData);
      tr.appendChild(tdPeso);
      listaPesos.appendChild(tr);
    }

    function calcularMediaPesoUltimos7Dias(docsPesos) {
      const hoje = new Date();
      const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
      const seteDiasAtras = new Date(hojeSemHora);
      seteDiasAtras.setDate(seteDiasAtras.getDate() - 6);

      let somaPesos = 0;
      let qtdRegistros = 0;

      docsPesos.forEach((doc) => {
        const dados = doc.data();
        const dataISO = dados.data;
        const peso = Number(dados.peso);
        if (!dataISO || isNaN(peso)) return;

        const dataRegistro = new Date(dataISO + "T00:00:00");
        if (dataRegistro >= seteDiasAtras && dataRegistro <= hojeSemHora) {
          somaPesos += peso;
          qtdRegistros++;
        }
      });

      return {
        mediaPeso7d: qtdRegistros > 0 ? somaPesos / qtdRegistros : null,
        qtdRegistrosPesos7d: qtdRegistros
      };
    }

    async function carregarCaloriasParaResumo(uid) {
      let mediaCalorias7d = null;
      let qtdDiasCalorias7d = 0;

      try {
        const hoje = new Date();
        const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
        const seteDiasAtras = new Date(hojeSemHora);
        seteDiasAtras.setDate(seteDiasAtras.getDate() - 6);

        const snapshot = await db
          .collection("consumosDiarios") // >>> TROCAR NOME DA COLE√á√ÉO SE PRECISAR
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          return { mediaCalorias7d: null, qtdDiasCalorias7d: 0 };
        }

        let somaCalorias = 0;
        let diasComRegistro = 0;

        snapshot.forEach((doc) => {
          const dados = doc.data();
          const dataISO = dados.data;
          const calorias = Number(dados.caloriasTotais || dados.calorias);
          if (!dataISO || isNaN(calorias)) return;

          const dataRegistro = new Date(dataISO + "T00:00:00");
          if (dataRegistro >= seteDiasAtras && dataRegistro <= hojeSemHora) {
            somaCalorias += calorias;
            diasComRegistro++;
          }
        });

        if (diasComRegistro > 0) {
          mediaCalorias7d = somaCalorias / diasComRegistro;
          qtdDiasCalorias7d = diasComRegistro;
        }
      } catch (err) {
        console.error("Erro ao carregar calorias para resumo:", err);
      }

      return { mediaCalorias7d, qtdDiasCalorias7d };
    }

    async function montarResumoGeral(uid, docsPesos, ultimoPesoDoc) {
      const { mediaPeso7d, qtdRegistrosPesos7d } = calcularMediaPesoUltimos7Dias(docsPesos);
      const { mediaCalorias7d, qtdDiasCalorias7d } = await carregarCaloriasParaResumo(uid);

      atualizarResumo(ultimoPesoDoc, mediaPeso7d, mediaCalorias7d, qtdRegistrosPesos7d, qtdDiasCalorias7d);
    }

    function atualizarResumo(
      ultimoPesoDoc,
      mediaPeso7d,
      mediaCalorias7d,
      qtdRegistrosPesos7d,
      qtdDiasCalorias7d
    ) {
      if (!ultimoPesoDoc && mediaPeso7d === null && mediaCalorias7d === null) {
        resumoConteudo.innerHTML = `
          <p>Ainda n√£o h√° dados suficientes para o resumo.</p>
          <small>Comece registrando seu peso, suas medidas e montando seus pratos para ver o resumo dos √∫ltimos 7 dias.</small>
        `;
        return;
      }

      let linhaPeso = "";
      if (mediaPeso7d !== null) {
        const pesoFormatado = mediaPeso7d.toLocaleString("pt-BR", {
          minimumFractionDigits: 1,
          maximumFractionDigits: 1
        });
        linhaPeso = `
          <li>
            <span>Peso m√©dio (√∫ltimos 7 dias): </span>
            <strong>${pesoFormatado} kg</strong>
            <small style="color: var(--text-muted);"> (${qtdRegistrosPesos7d} registro(s))</small>
          </li>
        `;
      } else {
        linhaPeso = `
          <li>
            <span>Peso m√©dio (√∫ltimos 7 dias): </span>
            <strong>‚Äî</strong>
            <small style="color: var(--text-muted);"> Sem registros no per√≠odo</small>
          </li>
        `;
      }

      let linhaCalorias = "";
      if (mediaCalorias7d !== null) {
        const caloriasFormatadas = Math.round(mediaCalorias7d).toLocaleString("pt-BR");
        linhaCalorias = `
          <li>
            <span>Consumo m√©dio de calorias (√∫ltimos 7 dias): </span>
            <strong>${caloriasFormatadas} kcal/dia</strong>
            <small style="color: var(--text-muted);"> (${qtdDiasCalorias7d} dia(s) com registro)</small>
          </li>
        `;
      } else {
        linhaCalorias = `
          <li>
            <span>Consumo m√©dio de calorias (√∫ltimos 7 dias): </span>
            <strong>‚Äî</strong>
            <small style="color: var(--text-muted);"> Sem registros no per√≠odo</small>
          </li>
        `;
      }

      let blocoUltimoPeso = "";
      if (ultimoPesoDoc) {
        const dados = ultimoPesoDoc.data();
        const dataISO = dados.data;
        const peso = dados.peso;

        const dataBR = formatarDataBR(dataISO);
        const pesoFormatado = Number(peso).toLocaleString("pt-BR", {
          minimumFractionDigits: 1,
          maximumFractionDigits: 1
        });

        blocoUltimoPeso = `
          <p style="margin-top:10px;">
            √öltimo registro em <strong>${dataBR}</strong> com <strong>${pesoFormatado} kg</strong>.
          </p>
          <small>Continue registrando seu peso para ver a evolu√ß√£o ao longo das semanas.</small>
        `;
      }

      resumoConteudo.innerHTML = `
        <p style="margin-bottom:6px;"><strong>Resumo dos √∫ltimos 7 dias</strong></p>
        <ul class="resumo-lista">
          ${linhaPeso}
          ${linhaCalorias}
        </ul>
        ${blocoUltimoPeso}
      `;
    }

    function formatarDataBR(dataISO) {
      if (!dataISO) return "";
      const [ano, mes, dia] = dataISO.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    async function salvarPeso() {
      mostrarMensagem(pesoMessage, "");

      const data = pesoDataInput.value;
      const peso = parseFloat(pesoValorInput.value);

      if (!data || isNaN(peso)) {
        mostrarMensagem(pesoMessage, "Preencha a data e o peso.", "error");
        return;
      }

      if (!currentUid) {
        mostrarMensagem(
          pesoMessage,
          "N√£o foi poss√≠vel identificar sua conta. Tente sair e entrar novamente.",
          "error"
        );
        return;
      }

      btnSalvarPeso.disabled = true;
      mostrarMensagem(pesoMessage, "Salvando...", "ok");

      try {
        const docId = `${currentUid}_${data}`;
        await db.collection("pesos").doc(docId).set({
          uid: currentUid,
          data,
          peso
        });

        mostrarMensagem(pesoMessage, "Peso salvo com sucesso!", "ok");
        await carregarPesos(currentUid);
      } catch (err) {
        console.error("Erro ao salvar peso:", err);
        mostrarMensagem(pesoMessage, "Erro ao salvar peso. Tente novamente.", "error");
      } finally {
        btnSalvarPeso.disabled = false;
      }
    }

    // ===== PERFIL & CONTA =====
    async function carregarPerfil(uid, user) {
      perfilMessage.style.display = "none";

      try {
        const docRef = db.collection("perfis").doc(uid);
        const docSnap = await docRef.get();

        if (docSnap.exists) {
          const dados = docSnap.data();
          perfilNomeInput.value = dados.nome || user.displayName || "";
          perfilEmailInput.value = user.email || "";
          perfilDataNascimentoInput.value = dados.dataNascimento || "";
        } else {
          perfilNomeInput.value = user.displayName || "";
          perfilEmailInput.value = user.email || "";
          perfilDataNascimentoInput.value = "";
        }
      } catch (err) {
        console.error("Erro ao carregar perfil:", err);
        perfilMessage.style.display = "block";
        perfilMessage.textContent = "N√£o foi poss√≠vel carregar seu perfil.";
      }
    }

    async function salvarPerfil() {
      perfilMessage.style.display = "none";

      const nome = perfilNomeInput.value.trim();
      const dataNascimento = perfilDataNascimentoInput.value;

      if (!currentUid || !currentUser) {
        perfilMessage.style.display = "block";
        perfilMessage.textContent = "N√£o foi poss√≠vel identificar sua conta.";
        return;
      }

      btnSalvarPerfil.disabled = true;
      perfilMessage.style.display = "block";
      perfilMessage.textContent = "Salvando...";

      try {
        await db.collection("perfis").doc(currentUid).set(
          {
            nome,
            dataNascimento,
            email: currentUser.email || ""
          },
          { merge: true }
        );

        try {
          if (nome) {
            await currentUser.updateProfile({ displayName: nome });
            localStorage.setItem("pp_user_nome", nome);
          }
        } catch (e) {
          console.warn("N√£o foi poss√≠vel atualizar displayName:", e);
        }

        perfilMessage.textContent = "Perfil atualizado com sucesso!";
      } catch (err) {
        console.error("Erro ao salvar perfil:", err);
        perfilMessage.textContent = "Erro ao salvar perfil. Tente novamente.";
      } finally {
        btnSalvarPerfil.disabled = false;
      }
    }

    async function excluirConta() {
      if (!currentUid || !currentUser) {
        mostrarMensagem(excluirMessage, "N√£o foi poss√≠vel identificar sua conta.", "error");
        return;
      }

      const confirma = confirm(
        "Tem certeza que deseja excluir sua conta? Essa a√ß√£o √© definitiva e n√£o poder√° ser desfeita."
      );
      if (!confirma) return;

      btnExcluirConta.disabled = true;
      mostrarMensagem(excluirMessage, "Excluindo sua conta e dados...", "ok");

      try {
        const pesosSnap = await db
          .collection("pesos")
          .where("uid", "==", currentUid)
          .get();
        const batch = db.batch();
        pesosSnap.forEach((doc) => batch.delete(doc.ref));
        await batch.commit();

        await db.collection("perfis").doc(currentUid).delete().catch(() => {});

        const planoCodigo = localStorage.getItem("pp_plano_codigo");
        if (planoCodigo) {
          const refPlano = db.collection("planos").doc(planoCodigo);
          await refPlano.set(
            {
              ultimoUidRemovido: currentUid,
              updatedAt: new Date().toISOString()
            },
            { merge: true }
          );
        }

        await currentUser.delete().catch((err) => {
          console.warn("Erro ao deletar usu√°rio do Auth:", err);
        });

        limparLocalStorageClube();
        mostrarMensagem(
          excluirMessage,
          "Conta exclu√≠da com sucesso. Obrigado por ter feito parte do Clube. ‚ù§Ô∏è",
          "ok"
        );

        setTimeout(() => {
          window.location.href = "clube-login.html";
        }, 2000);
      } catch (err) {
        console.error("Erro ao excluir conta:", err);
        mostrarMensagem(excluirMessage, "Erro ao excluir conta. Tente novamente mais tarde.", "error");
        btnExcluirConta.disabled = false;
      }
    }

    function fazerLogout() {
      auth.signOut().finally(() => {
        limparLocalStorageClube();
        window.location.href = "clube-login.html";
      });
    }

    function abrirPerfil() {
      perfilModal.classList.add("visible");
    }

    function fecharPerfil() {
      perfilModal.classList.remove("visible");
    }

    // ===== TDEE (CLUBE) =====
    async function carregarTDEE(uid) {
      if (!tdeeConteudo) return;

      tdeeConteudo.innerHTML = "<small>Buscando seu TDEE...</small>";

      try {
        const snapshot = await db
          .collection("tdee") // >>> TROCAR NOME DA COLE√á√ÉO SE PRECISAR
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          tdeeConteudo.innerHTML = `
            <p>Voc√™ ainda n√£o registrou um c√°lculo de TDEE dentro do Clube.</p>
            <small>Use a calculadora do Clube para salvar seu gasto di√°rio e meta de emagrecimento.</small>
          `;
          return;
        }

        const docs = snapshot.docs.slice();

        // ordena por dataCalculo desc (timestamp ou string)
        docs.sort((a, b) => {
          const da = a.data().dataCalculo;
          const dbb = b.data().dataCalculo;

          const va = da && da.toDate
            ? da.toDate().getTime()
            : (typeof da === "string" ? Date.parse(da) || 0 : 0);

          const vb = dbb && dbb.toDate
            ? dbb.toDate().getTime()
            : (typeof dbb === "string" ? Date.parse(dbb) || 0 : 0);

          return vb - va;
        });

        const doc = docs[0];
        const dados = doc.data();

        const tdeeValor   = dados.tdee;
        const gastoBasal  = dados.gastoBasal || dados.basal;
        const metodo      = dados.metodo || "M√©todo padr√£o";
        const atividade   = dados.nivelAtividade || dados.atividade || "";

        const metaTipo       = dados.metaTipo || dados.objetivo || null;
        const metaCalorias   = dados.metaCalorias || null;
        const metaDeficitDia = dados.metaDeficitDia || null;
        const metaKgSemana   = dados.metaKgSemana || null;

        const tdeeFormatado =
          tdeeValor != null ? Math.round(tdeeValor).toLocaleString("pt-BR") : "‚Äî";
        const basalFormatado =
          gastoBasal != null ? Math.round(gastoBasal).toLocaleString("pt-BR") : "‚Äî";

        let metaHTML = "";
        if (metaCalorias != null) {
          const metaCaloriasFmt = Math.round(metaCalorias).toLocaleString("pt-BR");
          const deficitFmt =
            metaDeficitDia != null
              ? Math.round(metaDeficitDia).toLocaleString("pt-BR") + " kcal/dia"
              : null;
          const kgSemanaFmt =
            metaKgSemana != null
              ? metaKgSemana.toLocaleString("pt-BR", {
                  minimumFractionDigits: 1,
                  maximumFractionDigits: 1
                }) + " kg/sem"
              : null;

          metaHTML = `
            <p style="margin-top:6px;">
              <span style="font-size:0.84rem; color:var(--text-muted);">Meta de emagrecimento (Clube):</span><br/>
              Calorias alvo: <strong>${metaCaloriasFmt} kcal/dia</strong><br/>
              ${deficitFmt ? `D√©ficit estimado: <strong>${deficitFmt}</strong><br/>` : ""}
              ${kgSemanaFmt ? `Velocidade prevista: <strong>${kgSemanaFmt}</strong>` : ""}
              ${
                metaTipo
                  ? `<br/><span style="font-size:0.8rem; color:var(--text-muted);">Objetivo: <strong>${metaTipo}</strong></span>`
                  : ""
              }
            </p>
          `;
        }

        tdeeConteudo.innerHTML = `
          <p><strong>${tdeeFormatado} kcal/dia</strong> √© seu TDEE atual.</p>
          <p style="margin-top:4px; font-size:0.85rem; color:var(--text-muted);">
            Gasto basal estimado: <strong>${basalFormatado} kcal</strong><br/>
            M√©todo: <strong>${metodo}</strong>${atividade ? ` ‚Ä¢ Atividade: <strong>${atividade}</strong>` : ""}
          </p>
          ${metaHTML}
        `;
      } catch (err) {
        console.error("Erro ao carregar TDEE:", err);
        tdeeConteudo.innerHTML = `
          <p>N√£o foi poss√≠vel carregar seu TDEE.</p>
          <small>Tente novamente em alguns instantes.</small>
        `;
      }
    }

    // ===== PRATO BRASILEIRO (CLUBE) =====
    async function carregarUltimoPrato(uid) {
      if (!pratoConteudo) return;

      pratoConteudo.innerHTML = "<small>Buscando seus pratos...</small>";

      try {
        const snapshot = await db
          .collection("consumosDiarios") // >>> TROCAR NOME DA COLE√á√ÉO SE PRECISAR
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          pratoConteudo.innerHTML = `
            <p>Voc√™ ainda n√£o registrou um prato dentro do Clube.</p>
            <small>Monte seu prato brasileiro na vers√£o do Clube para ver um resumo aqui.</small>
          `;
          return;
        }

        const docs = snapshot.docs.slice();

        docs.sort((a, b) => {
          const da = (a.data().data || "");
          const dbb = (b.data().data || "");
          if (da < dbb) return 1;
          if (da > dbb) return -1;
          return 0;
        });

        const doc = docs[0];
        const dados = doc.data();

        const dataISO = dados.data;
        const dataBR = formatarDataBR(dataISO);

        const calorias = Number(dados.caloriasTotais || dados.calorias);
        const caloriasFormatadas =
          !isNaN(calorias) && calorias > 0
            ? Math.round(calorias).toLocaleString("pt-BR")
            : "‚Äî";

        const proteinas = typeof dados.proteinas === "number" ? dados.proteinas : null;
        const carbo = typeof dados.carboidratos === "number" ? dados.carboidratos : null;
        const gorduras = typeof dados.gorduras === "number" ? dados.gorduras : null;

        let macrosHTML = "";
        const partesMacros = [];
        if (proteinas !== null) partesMacros.push(`<strong>${proteinas} g</strong> de prote√≠na`);
        if (carbo !== null) partesMacros.push(`<strong>${carbo} g</strong> de carboidratos`);
        if (gorduras !== null) partesMacros.push(`<strong>${gorduras} g</strong> de gorduras`);

        if (partesMacros.length) {
          macrosHTML = `
            <p style="margin-top:4px; font-size:0.85rem; color:var(--text-muted);">
              ${partesMacros.join(" ‚Ä¢ ")}
            </p>
          `;
        }

        pratoConteudo.innerHTML = `
          <p>√öltimo prato em <strong>${dataBR || "-"}</strong>.</p>
          <p style="margin-top:4px;">
            Consumo total do dia: <strong>${caloriasFormatadas} kcal</strong>.
          </p>
          ${macrosHTML}
        `;
      } catch (err) {
        console.error("Erro ao carregar dados de prato:", err);
        pratoConteudo.innerHTML = `
          <p>N√£o foi poss√≠vel carregar seus dados de prato.</p>
          <small>Tente novamente em alguns instantes.</small>
        `;
      }
    }

    // ===== MEDIDAS CORPORAIS (CLUBE) =====
    async function carregarMedidas(uid) {
      if (!medidasConteudo) return;

      medidasConteudo.innerHTML = "<small>Buscando suas medidas...</small>";

      try {
        const snapshot = await db
          .collection("medidasCorporais") // >>> TROCAR NOME DA COLE√á√ÉO SE VOC√ä QUISER OUTRO
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          medidasConteudo.innerHTML = `
            <p>Voc√™ ainda n√£o registrou suas medidas corporais dentro do Clube.</p>
            <small>Use o bot√£o abaixo para registrar medidas como cintura, abd√¥men, bra√ßos e pernas.</small>
          `;
          return;
        }

        const docs = snapshot.docs.slice();

        // assume que cada doc tem campo "data" (AAAA-MM-DD) da avalia√ß√£o
        docs.sort((a, b) => {
          const da = (a.data().data || "");
          const dbb = (b.data().data || "");
          if (da < dbb) return 1;
          if (da > dbb) return -1;
          return 0;
        });

        const doc = docs[0];
        const m = doc.data();

        const dataBR = formatarDataBR(m.data);

        // valores em cm (podem vir como number ou string)
        function fmtMedida(v) {
          if (v === undefined || v === null || v === "") return "‚Äî";
          const n = Number(v);
          if (isNaN(n)) return "‚Äî";
          return n.toLocaleString("pt-BR", {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1
          }) + " cm";
        }

        const cards = [
          { label: "Pesco√ßo", valor: fmtMedida(m.pescoco) },
          { label: "Ombro", valor: fmtMedida(m.ombro) },
          { label: "Peito", valor: fmtMedida(m.peito) },
          { label: "Cintura", valor: fmtMedida(m.cintura) },
          { label: "Abd√¥men superior", valor: fmtMedida(m.abdomenSuperior) },
          { label: "Abd√¥men inferior", valor: fmtMedida(m.abdomenInferior) },
          { label: "Bra√ßo (esquerdo)", valor: fmtMedida(m.bracoEsquerdo) },
          { label: "Bra√ßo (direito)", valor: fmtMedida(m.bracoDireito) },
          { label: "Antebra√ßo (esquerdo)", valor: fmtMedida(m.antebracoEsquerdo) },
          { label: "Antebra√ßo (direito)", valor: fmtMedida(m.antebracoDireito) },
          { label: "Coxa (esquerda)", valor: fmtMedida(m.coxaEsquerda) },
          { label: "Coxa (direita)", valor: fmtMedida(m.coxaDireita) },
          { label: "Panturrilha (esquerda)", valor: fmtMedida(m.panturrilhaEsquerda) },
          { label: "Panturrilha (direita)", valor: fmtMedida(m.panturrilhaDireita) },
          { label: "Quadril", valor: fmtMedida(m.quadril) }
        ];

        const cardsHTML = cards
          .map(
            (c) => `
          <div class="medida-item">
            <span class="medida-label">${c.label}</span>
            <strong>${c.valor}</strong>
          </div>
        `
          )
          .join("");

        medidasConteudo.innerHTML = `
          <p style="margin-bottom:6px;">
            √öltima avalia√ß√£o registrada em <strong>${dataBR || "-"}</strong>.
          </p>
          <div class="medidas-grid">
            ${cardsHTML}
          </div>
        `;
      } catch (err) {
        console.error("Erro ao carregar medidas corporais:", err);
        medidasConteudo.innerHTML = `
          <p>N√£o foi poss√≠vel carregar suas medidas corporais.</p>
          <small>Tente novamente em alguns instantes.</small>
        `;
      }
    }

    // ===== INICIALIZA√á√ÉO =====
    document.addEventListener("DOMContentLoaded", () => {
      const anoAtualSpan = document.getElementById("anoAtual");
      anoAtualSpan.textContent = new Date().getFullYear();

      setHojeNoCampoPeso();

      btnLogout.addEventListener("click", fazerLogout);
      btnSalvarPeso.addEventListener("click", salvarPeso);
      btnSalvarPerfil.addEventListener("click", salvarPerfil);
      btnExcluirConta.addEventListener("click", excluirConta);

      btnOpenPerfil.addEventListener("click", abrirPerfil);
      btnFecharPerfil.addEventListener("click", fecharPerfil);
      perfilModal.addEventListener("click", (e) => {
        if (e.target === perfilModal) fecharPerfil();
      });

      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = "clube-login.html";
          return;
        }

        currentUser = user;
        currentUid = user.uid;

        try {
          localStorage.setItem("pp_user_uid", user.uid);
          localStorage.setItem("pp_user_email", user.email || "");
          if (user.displayName) {
            localStorage.setItem("pp_user_nome", user.displayName);
          }
        } catch (e) {
          console.warn("N√£o foi poss√≠vel atualizar localStorage com dados do usu√°rio:", e);
        }

        if (user.displayName) {
          userGreeting.textContent = `Ol√°, ${user.displayName}! üëã`;
        } else {
          userGreeting.textContent = "Ol√°! üëã";
        }

        await carregarPerfil(currentUid, user);
        await carregarPesos(currentUid);
        await carregarTDEE(currentUid);
        await carregarUltimoPrato(currentUid);
        await carregarMedidas(currentUid);
      });
    });
  </script>
</body>
</html>
