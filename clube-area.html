<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Clube Prato & Peso – Minha área</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f3f4f6;
      --bg-alt: #ffffff;
      --primary: #145a32;
      --primary-soft: #e0f2f1;
      --accent: #facc15;
      --accent-text: #78350f;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
      --radius-lg: 18px;
      --radius-xl: 22px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
      --max-width: 1120px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf5dd 0, #f3f4f6 45%, #e5e7eb 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* HEADER SUPERIOR */
    header {
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
    }

    .topbar-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-badge {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 0.9rem;
      color: var(--accent-text);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.16);
    }

    .brand-name {
      font-weight: 700;
      letter-spacing: 0.03em;
      font-size: 1rem;
    }

    .goal-pill {
      border-radius: 999px;
      padding: 8px 18px;
      border: none;
      background: var(--primary);
      color: #ffffff;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: default;
      box-shadow: 0 12px 26px rgba(21, 128, 61, 0.5);
      white-space: nowrap;
    }

    /* CONTEÚDO PRINCIPAL */
    main {
      padding: 24px 16px 36px;
    }

    .main-inner {
      max-width: var(--max-width);
      margin: 0 auto;
    }

    .hero {
      margin-bottom: 22px;
    }

    .hero h1 {
      font-size: 1.8rem;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .hero p {
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    /* GRID DE CARDS */
    .cards-grid {
      display: grid;
      gap: 16px;
    }

    @media (min-width: 720px) {
      .cards-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .card {
      background: var(--bg-alt);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);
      padding: 16px 16px 18px;
    }

    .card-full {
      grid-column: 1 / -1;
    }

    .card h2 {
      font-size: 1rem;
      margin-bottom: 6px;
    }

    .card-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .metrics {
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 14px;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 4px;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 0.86rem;
      color: var(--text-muted);
    }

    .metric-value {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .metric-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.78rem;
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 600;
      margin-top: 2px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 10px 22px rgba(21, 128, 61, 0.5);
    }

    .btn-ghost {
      background: #e5efe9;
      color: var(--primary);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .help-text {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    footer {
      padding: 10px 16px 18px;
      font-size: 0.78rem;
      color: #9ca3af;
      text-align: center;
    }

    /* ========= PESO & PROGRESSO ========= */

    .peso-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .peso-main {
      min-width: 120px;
    }

    .peso-valor {
      font-size: 1.4rem;
      font-weight: 800;
    }

    .peso-legend {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .peso-chart-container {
      flex: 1;
      min-width: 160px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .peso-chart-mini-wrapper {
      border-radius: 16px;
      background: radial-gradient(circle at top, #dcfce7 0, #ffffff 45%, #f9fafb 100%);
      border: 1px solid rgba(74, 222, 128, 0.5);
      padding: 6px;
      height: 130px;
      display: flex;
      align-items: stretch;
    }

    .peso-chart-mini-wrapper canvas {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      background: #ffffff;
    }

    .peso-chart-mini-caption {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: right;
    }

    /* TAGS MEDIDAS – chips */
    .tags-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag-pill {
      background: #f3f4ff;
      color: #1e293b;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: baseline;
      gap: 4px;
    }

    .tag-pill strong {
      font-size: 0.83rem;
    }

    @media (max-width: 480px) {
      .hero h1 {
        font-size: 1.6rem;
      }
      .topbar-inner {
        padding-inline: 12px;
      }
      main {
        padding-inline: 12px;
      }
      .peso-wrapper {
        flex-direction: column;
      }
      .peso-chart-mini-caption {
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-badge">PaP</div>
        <span class="brand-name">Prato &amp; Peso</span>
      </div>
      <button class="goal-pill" id="pill-meta">Emagrecer 10 kg</button>
    </div>
  </header>

  <main>
    <div class="main-inner">
      <!-- Saudação -->
      <section class="hero">
        <h1>Olá, Rafael</h1>
        <p>Você vem adiantando a meta nos últimos 7 dias.</p>
      </section>

      <!-- Cards -->
      <section class="cards-grid">
        <!-- Resumo de hoje (ainda estático) -->
        <article class="card" id="card-resumo-hoje">
          <h2>Resumo de hoje</h2>
          <p class="card-subtitle">Visão rápida do seu dia em calorias.</p>

          <div class="metrics">
            <div class="metric-row">
              <span class="metric-label">Gasto estimado hoje</span>
              <span class="metric-value"><strong>2.300 kcal</strong></span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Ingeriu hoje</span>
              <span class="metric-value"><strong>1.450 kcal</strong></span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Saldo do dia</span>
              <span class="metric-value" style="color:#16a34a;"><strong>–850 kcal</strong></span>
            </div>
          </div>
        </article>

        <!-- Peso & progresso -->
        <article class="card" id="card-peso-progresso">
          <h2>Peso &amp; progresso</h2>
          <p class="card-subtitle">Seu peso atual e a tendência da meta.</p>

          <div class="peso-wrapper">
            <div class="peso-main">
              <div class="peso-valor" id="peso-atual">--,-- kg</div>
              <div class="peso-legend" id="peso-variacao7-text">
                Carregando dados de peso...
              </div>
            </div>

            <div class="peso-chart-container">
              <div class="peso-chart-mini-wrapper">
                <canvas id="graficoPesoMini"></canvas>
              </div>
              <div class="peso-chart-mini-caption">Últimos 7 registros</div>
            </div>
          </div>

          <button
            class="btn btn-primary"
            type="button"
            onclick="window.location.href='clube-peso.html'"
          >
            Ver e registrar peso
          </button>
        </article>

        <!-- Meu TDEE & Meta -->
        <article class="card" id="card-tdee-meta">
          <h2>Meu TDEE &amp; Meta</h2>
          <p class="card-subtitle">Resumo do gasto calórico diário e da meta.</p>

          <div class="metrics">
            <div class="metric-row">
              <span class="metric-label">TDEE atual</span>
              <span class="metric-value">
                <strong id="tdee-atual">-- kcal/dia</strong>
              </span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Objetivo</span>
              <span class="metric-value">
                <strong id="tdee-meta-descricao">Nenhum cálculo salvo ainda.</strong>
              </span>
            </div>
            <span class="metric-badge" id="tdee-consumo-resumo">
              Consumo total hoje: — kcal
            </span>
          </div>

          <button class="btn btn-primary" type="button"
                  onclick="window.location.href='clube-tdee.html'">
            Ver detalhes da meta
          </button>
        </article>

        <!-- Minhas medidas corporais -->
        <article class="card" id="card-medidas">
          <h2>Minhas medidas corporais</h2>
          <p class="card-subtitle">Acompanhe as principais medidas do seu corpo.</p>

          <div class="tags-grid" id="medidas-resumo">
            <div class="tag-pill">
              <span>Braço</span>
              <strong id="medida-braco">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Cintura</span>
              <strong id="medida-cintura">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Coxa</span>
              <strong id="medida-coxa">-- cm</strong>
            </div>
            <div class="tag-pill">
              <span>Quadril</span>
              <strong id="medida-quadril">-- cm</strong>
            </div>
          </div>

          <p class="help-text" id="medidas-legenda">
            Carregando últimas medidas...
          </p>

          <button class="btn btn-primary" style="margin-top:8px;" type="button"
                  onclick="window.location.href='clube-medidas.html'">
            Registrar / atualizar medidas
          </button>
        </article>

        <!-- Montar prato brasileiro -->
        <article class="card" id="card-prato">
          <h2>Montar prato brasileiro</h2>
          <p class="card-subtitle" id="card-prato-subtitle">(hoje)</p>

          <div class="metrics">
            <div class="metric-row">
              <span class="metric-label">Último prato registrado em</span>
              <span class="metric-value">
                <strong id="prato-data">—</strong>
              </span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Consumo total hoje</span>
              <span class="metric-value">
                <strong id="prato-calorias">—</strong>
              </span>
            </div>
          </div>

          <button
            class="btn btn-primary"
            type="button"
            onclick="window.location.href='clube-prato.html'"
          >
            Montar / atualizar prato de hoje
          </button>
        </article>

        <!-- Treino de hoje / Academia (por enquanto estático) -->
        <article class="card" id="card-treino">
          <h2>Treino de hoje / Academia</h2>
          <p class="card-subtitle">Últimos pesos para você lembrar na próxima sessão.</p>

          <ul class="list-simple">
            <li><strong>Último treino:</strong> 24/11/2025 – Treino A (Peito/Tríceps)</li>
            <li><strong>Supino reto:</strong> 60 kg</li>
            <li><strong>Leg press:</strong> 200 kg</li>
          </ul>

          <button class="btn btn-primary" type="button">
            Registrar treino de hoje
          </button>
        </article>

        <!-- Relatório simples do Clube -->
        <article class="card card-full" id="card-relatorio">
          <h2>Relatório simples do Clube</h2>
          <p class="card-subtitle">
            Gere um relatório com peso, calorias, pratos e treinos para um período específico.
          </p>

          <p class="help-text">
            Escolha um intervalo de datas e veja um PDF simples com a evolução da sua meta.
          </p>

          <div class="btn-row">
            <button class="btn btn-primary" type="button" onclick="window.location.href='relatorio.html'">
              Abrir relatório simples
            </button>
            <button class="btn-ghost" type="button">
              Escolher período
            </button>
          </div>
        </article>
      </section>
    </div>
  </main>

  <footer>
    © 2025 Prato &amp; Peso – Área do Clube.
  </footer>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyABfAWUAW6a6g93B9QKooTKd5Mj645G3vE",
      authDomain: "prato-e-peso-77b5a.firebaseapp.com",
      projectId: "prato-e-peso-77b5a",
      storageBucket: "prato-e-peso-77b5a.firebasestorage.app",
      messagingSenderId: "432109202072",
      appId: "1:432109202072:web:1c8636db0c161318ddfeed"
    };

    // Evita erro se outra página já tiver inicializado (não deve, mas por segurança)
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db   = firebase.firestore();

    let currentUid = null;

    // --- elementos prato ---
    const pratoDataSpan     = document.getElementById("prato-data");
    const pratoCaloriasSpan = document.getElementById("prato-calorias");
    const pratoSubtitle     = document.getElementById("card-prato-subtitle");

    // --- elementos peso ---
    const pesoAtualSpan     = document.getElementById("peso-atual");
    const pesoVariacao7Text = document.getElementById("peso-variacao7-text");

    // --- elementos TDEE ---
    const tdeeAtualSpan        = document.getElementById("tdee-atual");
    const tdeeMetaDescricao    = document.getElementById("tdee-meta-descricao");
    const tdeeConsumoResumo    = document.getElementById("tdee-consumo-resumo");
    const pillMeta             = document.getElementById("pill-meta");

    // --- elementos Medidas corporais ---
    const medidaBracoSpan    = document.getElementById("medida-braco");
    const medidaCinturaSpan  = document.getElementById("medida-cintura");
    const medidaCoxaSpan     = document.getElementById("medida-coxa");
    const medidaQuadrilSpan  = document.getElementById("medida-quadril");
    const medidasLegenda     = document.getElementById("medidas-legenda");

    let graficoPesoMini = null;
    let consumoTotalHojeFmt = "— kcal";

    function formatarDataBR(dataISO) {
      if (!dataISO) return "";
      const partes = dataISO.split("-");
      if (partes.length !== 3) return dataISO;
      const [ano, mes, dia] = partes;
      return `${dia}/${mes}`;
    }

    function formatarNumero(valor, casas) {
      if (valor === null || valor === undefined || isNaN(valor)) return "—";
      return Number(valor).toLocaleString("pt-BR", {
        minimumFractionDigits: casas,
        maximumFractionDigits: casas
      });
    }

    function atualizarTdeeConsumoResumo() {
      if (tdeeConsumoResumo) {
        tdeeConsumoResumo.textContent = "Consumo total hoje: " + consumoTotalHojeFmt;
      }
    }

    /* ====== MONTAR PRATO BRASILEIRO (card) ====== */
    async function carregarResumoPrato(uid) {
      if (!pratoDataSpan || !pratoCaloriasSpan) return;

      pratoDataSpan.textContent = "carregando...";
      pratoCaloriasSpan.textContent = "carregando...";
      consumoTotalHojeFmt = "— kcal";
      atualizarTdeeConsumoResumo();

      try {
        const snapshot = await db
          .collection("consumosDiarios")
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          pratoDataSpan.textContent = "—";
          pratoCaloriasSpan.textContent = "—";
          consumoTotalHojeFmt = "— kcal";
          atualizarTdeeConsumoResumo();
          if (pratoSubtitle) {
            pratoSubtitle.textContent = "Você ainda não registrou um prato no Clube.";
          }
          return;
        }

        const docs = snapshot.docs.slice();
        docs.sort((a, b) => {
          const da = a.data().data || "";
          const dbb = b.data().data || "";
          if (da < dbb) return 1;
          if (da > dbb) return -1;
          return 0;
        });

        const dados = docs[0].data();
        const dataISO = dados.data;
        const dataBR  = formatarDataBR(dataISO);

        const caloriasRaw = Number(dados.caloriasTotais || dados.calorias);
        const caloriasFmt =
          !isNaN(caloriasRaw) && caloriasRaw > 0
            ? Math.round(caloriasRaw).toLocaleString("pt-BR") + " kcal"
            : "—";

        pratoDataSpan.textContent = dataBR || "—";
        pratoCaloriasSpan.textContent = caloriasFmt;

        consumoTotalHojeFmt = caloriasFmt;
        atualizarTdeeConsumoResumo();

        if (pratoSubtitle) {
          pratoSubtitle.textContent = "Resumo do último prato registrado no Clube.";
        }
      } catch (err) {
        console.error("Erro ao carregar dados de prato:", err);
        pratoDataSpan.textContent = "—";
        pratoCaloriasSpan.textContent = "—";
        consumoTotalHojeFmt = "— kcal";
        atualizarTdeeConsumoResumo();
        if (pratoSubtitle) {
          pratoSubtitle.textContent = "Não foi possível carregar seus pratos agora.";
        }
      }
    }

    /* ====== DESENHO DO MINI GRÁFICO DE PESO (Chart.js, VERDE) ====== */
    function desenharGraficoPesoMini(labels, dados) {
      const canvas = document.getElementById("graficoPesoMini");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");

      if (graficoPesoMini) {
        graficoPesoMini.destroy();
        graficoPesoMini = null;
      }

      graficoPesoMini = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Peso (kg)",
              data: dados,
              borderColor: "rgba(22,163,74,1)",
              backgroundColor: "rgba(187,247,208,0.45)",
              tension: 0.3,
              borderWidth: 2,
              pointRadius: 3,
              pointHoverRadius: 4,
              pointBackgroundColor: "rgba(22,163,74,1)",
              pointBorderColor: "#ffffff",
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const valor = ctx.parsed.y;
                  return `Peso: ${formatarNumero(valor, 1)} kg`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { font: { size: 9 } },
              grid: { display: false }
            },
            y: {
              ticks: { font: { size: 9 } },
              grid: {
                color: "rgba(209, 250, 229, 0.9)",
                lineWidth: 0.8
              }
            }
          }
        }
      });
    }

    /* ====== PESO & PROGRESSO (texto + gráfico) ====== */
    async function carregarPesoEProgresso(uid) {
      if (!pesoAtualSpan || !pesoVariacao7Text) return;

      pesoAtualSpan.textContent = "--,-- kg";
      pesoVariacao7Text.textContent = "Carregando dados de peso...";
      pesoVariacao7Text.style.color = "#6b7280";
      desenharGraficoPesoMini([], []);

      try {
        const snapshot = await db
          .collection("pesos")
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          pesoVariacao7Text.textContent = "Você ainda não registrou seu peso no Clube.";
          return;
        }

        const docs = snapshot.docs.slice();
        docs.sort((a, b) => {
          const da = (a.data().data || "");
          const dbb = (b.data().data || "");
          if (da < dbb) return -1;
          if (da > dbb) return 1;
          return 0;
        });

        const registros = docs.map(d => {
          const dados = d.data();
          const peso = Number(
            dados.pesoKg ??
            dados.peso ??
            dados.pesoAtual
          );
          return { data: dados.data, peso };
        }).filter(r => !isNaN(r.peso));

        if (!registros.length) {
          pesoVariacao7Text.textContent = "Nenhum peso válido encontrado.";
          return;
        }

        const ultimos7 = registros.slice(-7);
        const ultimo = ultimos7[ultimos7.length - 1];

        const pesoAtualFmt = formatarNumero(ultimo.peso, 1);
        pesoAtualSpan.textContent = `${pesoAtualFmt} kg`;

        if (ultimos7.length >= 2) {
          const primeiro7 = ultimos7[0];
          const diff7 = ultimo.peso - primeiro7.peso;
          const diffAbsFmt = formatarNumero(Math.abs(diff7), 1);

          if (diff7 < 0) {
            pesoVariacao7Text.textContent =
              `Nos últimos ${ultimos7.length} registros: — ${diffAbsFmt} kg`;
            pesoVariacao7Text.style.color = "#16a34a";
          } else if (diff7 > 0) {
            pesoVariacao7Text.textContent =
              `Nos últimos ${ultimos7.length} registros: + ${diffAbsFmt} kg`;
            pesoVariacao7Text.style.color = "#b91c1c";
          } else {
            pesoVariacao7Text.textContent =
              `Nos últimos ${ultimos7.length} registros: 0,0 kg de variação`;
            pesoVariacao7Text.style.color = "#6b7280";
          }
        } else {
          pesoVariacao7Text.textContent =
            "Aguardando mais registros para calcular a variação.";
          pesoVariacao7Text.style.color = "#6b7280";
        }

        const labels = ultimos7.map(r => formatarDataBR(r.data || ""));
        const dados = ultimos7.map(r => r.peso);

        desenharGraficoPesoMini(labels, dados);
      } catch (err) {
        console.error("Erro ao carregar pesos:", err);
        pesoVariacao7Text.textContent =
          "Não foi possível carregar seus pesos agora.";
        pesoVariacao7Text.style.color = "#b91c1c";
      }
    }

    /* ====== RESUMO TDEE & META ====== */
    async function carregarResumoTdee(uid) {
      if (!tdeeAtualSpan || !tdeeMetaDescricao) return;

      tdeeAtualSpan.textContent     = "-- kcal/dia";
      tdeeMetaDescricao.textContent = "Carregando dados da meta...";

      try {
        const snapshot = await db
          .collection("tdee")
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          tdeeMetaDescricao.textContent = "Nenhum cálculo salvo ainda.";
          return;
        }

        const docs = snapshot.docs.slice();
        const getMillis = (doc) => {
          const v = doc.data().dataCalculo;
          if (!v || typeof v.toMillis !== "function") return 0;
          return v.toMillis();
        };
        docs.sort((a, b) => getMillis(b) - getMillis(a));

        const dados = docs[0].data();
        const tdee = Number(dados.tdee);
        const metaCalorias = Number(dados.metaCalorias);
        const metaTipo = dados.metaTipo || "Meta";
        const objetivoKg = dados.objetivoKg; // pode ter vindo da tela TDEE

        const tdeeFmt = !isNaN(tdee)
          ? Math.round(tdee).toLocaleString("pt-BR") + " kcal/dia"
          : "-- kcal/dia";
        const metaFmt = !isNaN(metaCalorias)
          ? Math.round(metaCalorias).toLocaleString("pt-BR") + " kcal/dia"
          : "— kcal/dia";

        tdeeAtualSpan.textContent = tdeeFmt;
        tdeeMetaDescricao.textContent = `${metaTipo} – meta ${metaFmt}`;

        if (objetivoKg && pillMeta) {
          pillMeta.textContent = `Emagrecer ${objetivoKg} kg`;
        }
      } catch (err) {
        console.error("Erro ao carregar resumo de TDEE:", err);
        tdeeMetaDescricao.textContent = "Não foi possível carregar seu TDEE agora.";
      }
    }

    /* ====== RESUMO MEDIDAS CORPORAIS ====== */
    async function carregarResumoMedidas(uid) {
      if (!medidaBracoSpan || !medidaCinturaSpan || !medidaCoxaSpan || !medidaQuadrilSpan) return;

      const reset = () => {
        medidaBracoSpan.textContent   = "-- cm";
        medidaCinturaSpan.textContent = "-- cm";
        medidaCoxaSpan.textContent    = "-- cm";
        medidaQuadrilSpan.textContent = "-- cm";
      };

      reset();
      if (medidasLegenda) {
        medidasLegenda.textContent = "Carregando últimas medidas...";
        medidasLegenda.style.color = "#6b7280";
      }

      try {
        const snapshot = await db
          .collection("medidasCorporais")
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          reset();
          if (medidasLegenda) {
            medidasLegenda.textContent = "Você ainda não registrou suas medidas corporais.";
          }
          return;
        }

        const docs = snapshot.docs.slice();
        docs.sort((a, b) => {
          const da = a.data().data || "";
          const dbb = b.data().data || "";
          if (da < dbb) return -1;
          if (da > dbb) return 1;
          return 0;
        });

        const ultimo = docs[docs.length - 1].data();

        const fmtCm = (v) => {
          if (v === undefined || v === null || isNaN(v)) return "— cm";
          return Number(v).toLocaleString("pt-BR", {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1
          }) + " cm";
        };

        const braco  = ultimo.bracoDireito  ?? ultimo.bracoEsquerdo;
        const coxa   = ultimo.coxaDireita   ?? ultimo.coxaEsquerda;
        const cintura= ultimo.cintura;
        const quadril= ultimo.quadril;

        medidaBracoSpan.textContent   = fmtCm(braco);
        medidaCinturaSpan.textContent = fmtCm(cintura);
        medidaCoxaSpan.textContent    = fmtCm(coxa);
        medidaQuadrilSpan.textContent = fmtCm(quadril);

        if (medidasLegenda) {
          const dataTxt = ultimo.data ? formatarDataBR(ultimo.data) : "";
          medidasLegenda.textContent = dataTxt
            ? `Última avaliação em ${dataTxt}.`
            : "Última avaliação registrada.";
        }
      } catch (err) {
        console.error("Erro ao carregar resumo de medidas:", err);
        reset();
        if (medidasLegenda) {
          medidasLegenda.textContent = "Não foi possível carregar suas medidas agora.";
          medidasLegenda.style.color = "#b91c1c";
        }
      }
    }

    /* ====== LOGIN / CARGA INICIAL ====== */
    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "clube-login.html";
        return;
      }
      currentUid = user.uid;
      carregarResumoPrato(currentUid);
      carregarPesoEProgresso(currentUid);
      carregarResumoTdee(currentUid);
      carregarResumoMedidas(currentUid);
    });
  </script>
</body>
</html>
