<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Clube Prato & Peso – Medidas corporais</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f5f5f7;
      --bg-alt: #ffffff;
      --primary: #1e5a4d;
      --primary-soft: #e0f3ec;
      --accent: #ffb347;
      --accent-soft: #fff3df;
      --text-main: #222222;
      --text-muted: #666666;
      --border-soft: #e0e0e0;
      --radius-lg: 16px;
      --radius-xl: 22px;
      --shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.08);
      --max-width: 1040px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf5ea 0, #f5f5f7 45%, #f0f2f5 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: rgba(255,255,255,0.96);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit;
    }

    .logo-badge {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #4b2c15;
      font-size: 0.9rem;
      box-shadow: 0 6px 14px rgba(0,0,0,0.1);
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .logo-text-main {
      font-weight: 700;
      font-size: 0.98rem;
      letter-spacing: 0.03em;
    }

    .logo-text-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .header-pill {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-soft);
      background: #f5f5f7;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
    }

    main {
      flex: 1;
      padding: 24px 16px 40px;
    }

    .main-inner {
      max-width: var(--max-width);
      margin: 0 auto;
    }

    .card {
      background: var(--bg-alt);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);
      padding: 18px 16px;
      margin-bottom: 18px;
    }

    .card h1 {
      font-size: 1.25rem;
      margin-bottom: 4px;
    }

    .card small {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-top: 12px;
      margin-bottom: 4px;
    }

    input[type="number"],
    input[type="date"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      background: #f9fafb;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary-soft);
      background: #ffffff;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 6px;
    }

    .col {
      flex: 1;
      min-width: 140px;
    }

    button.primary {
      margin-top: 16px;
      background: var(--primary);
      color: #ffffff;
      border: none;
      border-radius: 999px;
      padding: 9px 18px;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,0.18);
    }

    .message {
      margin-top: 8px;
      font-size: 0.85rem;
      display: none;
    }
    .message.ok { color: #15803d; }
    .message.error { color: #b91c1c; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.85rem;
    }

    th, td {
      border-bottom: 1px solid rgba(148,163,184,0.4);
      padding: 6px 4px;
      text-align: left;
    }

    th {
      font-weight: 600;
      color: #4b5563;
    }

    footer {
      background: #111;
      color: #d0d0d0;
      font-size: 0.78rem;
      padding: 12px 16px 16px;
      margin-top: 12px;
    }

    .footer-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      text-align: center;
    }

    @media (max-width: 640px) {
      main { padding-inline: 12px; }
      .header-inner { padding-inline: 10px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <a href="clube-area.html" class="logo">
        <div class="logo-badge">P&amp;P</div>
        <div class="logo-text">
          <div class="logo-text-main">Prato &amp; Peso</div>
          <div class="logo-text-sub">Clube – Medidas corporais</div>
        </div>
      </a>

      <button class="header-pill" onclick="window.location.href='clube-area.html'">
        ← Voltar para o Clube
      </button>
    </div>
  </header>

  <main>
    <div class="main-inner">
      <!-- FORMULÁRIO -->
      <section class="card">
        <h1>Registrar medidas corporais</h1>
        <small>
          Use esta tela para registrar as medidas em centímetros (cm). Elas serão usadas no
          <strong>Resumo rápido</strong> e nos relatórios do Clube.
        </small>

        <div class="row">
          <div class="col">
            <label for="medidaData">Data</label>
            <input type="date" id="medidaData" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="medidaPescoco">Pescoço (cm)</label>
            <input type="number" id="medidaPescoco" step="0.1" min="0" />
          </div>
          <div class="col">
            <label for="medidaOmbro">Ombro (cm)</label>
            <input type="number" id="medidaOmbro" step="0.1" min="0" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="medidaPeito">Peito (cm)</label>
            <input type="number" id="medidaPeito" step="0.1" min="0" />
          </div>
          <div class="col">
            <label for="medidaCintura">Cintura (cm)</label>
            <input type="number" id="medidaCintura" step="0.1" min="0" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="medidaAbdSup">Abdômen superior (cm)</label>
            <input type="number" id="medidaAbdSup" step="0.1" min="0" />
          </div>
          <div class="col">
            <label for="medidaAbdInf">Abdômen inferior (cm)</label>
            <input type="number" id="medidaAbdInf" step="0.1" min="0" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="medidaBracoE">Braço esquerdo (cm)</label>
            <input type="number" id="medidaBracoE" step="0.1" min="0" />
          </div>
          <div class="col">
            <label for="medidaBracoD">Braço direito (cm)</label>
            <input type="number" id="medidaBracoD" step="0.1" min="0" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="medidaAntebracoE">Antebraço esquerdo (cm)</label>
            <input type="number" id="medidaAntebracoE" step="0.1" min="0" />
          </div>
          <div class="col">
            <label for="medidaAntebracoD">Antebraço direito (cm)</label>
            <input type="number" id="medidaAntebracoD" step="0.1" min="0" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="medidaCoxaE">Coxa esquerda (cm)</label>
            <input type="number" id="medidaCoxaE" step="0.1" min="0" />
          </div>
          <div class="col">
            <label for="medidaCoxaD">Coxa direita (cm)</label>
            <input type="number" id="medidaCoxaD" step="0.1" min="0" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="medidaPanturrilhaE">Panturrilha esquerda (cm)</label>
            <input type="number" id="medidaPanturrilhaE" step="0.1" min="0" />
          </div>
          <div class="col">
            <label for="medidaPanturrilhaD">Panturrilha direita (cm)</label>
            <input type="number" id="medidaPanturrilhaD" step="0.1" min="0" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="medidaQuadril">Quadril (cm)</label>
            <input type="number" id="medidaQuadril" step="0.1" min="0" />
          </div>
        </div>

        <button class="primary" id="btnSalvarMedidas">Salvar medidas no Clube</button>
        <div id="medidasMessage" class="message"></div>
      </section>

      <!-- HISTÓRICO -->
      <section class="card">
        <h1 style="font-size:1.1rem;">Histórico de avaliações</h1>
        <small>Veja as últimas datas cadastradas e algumas medidas principais.</small>

        <table id="tabelaMedidas">
          <thead>
            <tr>
              <th>Data</th>
              <th>Cintura (cm)</th>
              <th>Abd. sup. (cm)</th>
              <th>Quadril (cm)</th>
            </tr>
          </thead>
          <tbody id="listaMedidas"></tbody>
        </table>
      </section>
    </div>
  </main>

  <footer>
    <div class="footer-inner">
      © <span id="anoAtual"></span> Prato &amp; Peso – Clube. Medidas salvas na sua conta.
    </div>
  </footer>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyABfAWUAW6a6g93B9QKooTKd5Mj645G3vE",
      authDomain: "prato-e-peso-77b5a.firebaseapp.com",
      projectId: "prato-e-peso-77b5a",
      storageBucket: "prato-e-peso-77b5a.firebasestorage.app",
      messagingSenderId: "432109202072",
      appId: "1:432109202072:web:1c8636db0c161318ddfeed"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const anoAtualSpan = document.getElementById("anoAtual");
    anoAtualSpan.textContent = new Date().getFullYear();

    const dataInput           = document.getElementById("medidaData");
    const pescocoInput        = document.getElementById("medidaPescoco");
    const ombroInput          = document.getElementById("medidaOmbro");
    const peitoInput          = document.getElementById("medidaPeito");
    const cinturaInput        = document.getElementById("medidaCintura");
    const abdSupInput         = document.getElementById("medidaAbdSup");
    const abdInfInput         = document.getElementById("medidaAbdInf");
    const bracoEInput         = document.getElementById("medidaBracoE");
    const bracoDInput         = document.getElementById("medidaBracoD");
    const antebracoEInput     = document.getElementById("medidaAntebracoE");
    const antebracoDInput     = document.getElementById("medidaAntebracoD");
    const coxaEInput          = document.getElementById("medidaCoxaE");
    const coxaDInput          = document.getElementById("medidaCoxaD");
    const pantEInput          = document.getElementById("medidaPanturrilhaE");
    const pantDInput          = document.getElementById("medidaPanturrilhaD");
    const quadrilInput        = document.getElementById("medidaQuadril");

    const btnSalvarMedidas    = document.getElementById("btnSalvarMedidas");
    const medidasMessage      = document.getElementById("medidasMessage");
    const listaMedidas        = document.getElementById("listaMedidas");

    let currentUid = null;

    function setHoje() {
      const hoje = new Date();
      const yyyy = hoje.getFullYear();
      const mm = String(hoje.getMonth() + 1).padStart(2, "0");
      const dd = String(hoje.getDate()).padStart(2, "0");
      dataInput.value = `${yyyy}-${mm}-${dd}`;
    }

    function formatarDataBR(dataISO) {
      if (!dataISO) return "";
      const [ano, mes, dia] = dataISO.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    function mostrarMsg(texto, tipo) {
      medidasMessage.style.display = texto ? "block" : "none";
      medidasMessage.textContent = texto || "";
      medidasMessage.classList.remove("ok", "error");
      if (tipo === "ok") medidasMessage.classList.add("ok");
      if (tipo === "error") medidasMessage.classList.add("error");
    }

    function lerNumero(input) {
      const v = parseFloat(input.value.replace(",", "."));
      return isNaN(v) ? null : v;
    }

    async function salvarMedidas() {
      mostrarMsg("");

      if (!currentUid) {
        mostrarMsg("Não foi possível identificar sua conta. Faça login novamente.", "error");
        return;
      }

      const data = dataInput.value;
      if (!data) {
        mostrarMsg("Preencha a data da avaliação.", "error");
        return;
      }

      // ler todos os campos numéricos
      const valores = {
        pescoco: lerNumero(pescocoInput),
        ombro: lerNumero(ombroInput),
        peito: lerNumero(peitoInput),
        cintura: lerNumero(cinturaInput),
        abdomenSuperior: lerNumero(abdSupInput),
        abdomenInferior: lerNumero(abdInfInput),
        bracoEsquerdo: lerNumero(bracoEInput),
        bracoDireito: lerNumero(bracoDInput),
        antebracoEsquerdo: lerNumero(antebracoEInput),
        antebracoDireito: lerNumero(antebracoDInput),
        coxaEsquerda: lerNumero(coxaEInput),
        coxaDireita: lerNumero(coxaDInput),
        panturrilhaEsquerda: lerNumero(pantEInput),
        panturrilhaDireita: lerNumero(pantDInput),
        quadril: lerNumero(quadrilInput)
      };

      // checa se pelo menos uma medida foi preenchida
      const temAlguma = Object.values(valores).some(v => v !== null);
      if (!temAlguma) {
        mostrarMsg("Preencha pelo menos uma medida corporal.", "error");
        return;
      }

      btnSalvarMedidas.disabled = true;
      mostrarMsg("Salvando medidas no Clube...", "ok");

      try {
        const docId = `${currentUid}_${data}`;
        const payload = {
          uid: currentUid,
          data,
          atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
        };

        // só envia as medidas que não forem nulas
        Object.entries(valores).forEach(([chave, valor]) => {
          if (valor !== null) payload[chave] = valor;
        });

        await db.collection("medidasCorporais").doc(docId).set(payload);

        mostrarMsg("Medidas salvas com sucesso! ✅", "ok");
        await carregarMedidasLista(currentUid);
      } catch (err) {
        console.error("Erro ao salvar medidas corporais:", err);
        mostrarMsg("Erro ao salvar medidas. Tente novamente.", "error");
      } finally {
        btnSalvarMedidas.disabled = false;
      }
    }

    function fmtCm(valor) {
      if (valor === undefined || valor === null) return "—";
      const n = Number(valor);
      if (isNaN(n)) return "—";
      return n.toLocaleString("pt-BR", {
        minimumFractionDigits: 1,
        maximumFractionDigits: 1
      });
    }

    function preencherFormularioComUltima(doc) {
      if (!doc) return;
      const m = doc.data();

      // não mexe na data, só pré-carrega os valores para facilitar a próxima avaliação
      pescocoInput.value    = m.pescoco != null ? m.pescoco : "";
      ombroInput.value      = m.ombro != null ? m.ombro : "";
      peitoInput.value      = m.peito != null ? m.peito : "";
      cinturaInput.value    = m.cintura != null ? m.cintura : "";
      abdSupInput.value     = m.abdomenSuperior != null ? m.abdomenSuperior : "";
      abdInfInput.value     = m.abdomenInferior != null ? m.abdomenInferior : "";
      bracoEInput.value     = m.bracoEsquerdo != null ? m.bracoEsquerdo : "";
      bracoDInput.value     = m.bracoDireito != null ? m.bracoDireito : "";
      antebracoEInput.value = m.antebracoEsquerdo != null ? m.antebracoEsquerdo : "";
      antebracoDInput.value = m.antebracoDireito != null ? m.antebracoDireito : "";
      coxaEInput.value      = m.coxaEsquerda != null ? m.coxaEsquerda : "";
      coxaDInput.value      = m.coxaDireita != null ? m.coxaDireita : "";
      pantEInput.value      = m.panturrilhaEsquerda != null ? m.panturrilhaEsquerda : "";
      pantDInput.value      = m.panturrilhaDireita != null ? m.panturrilhaDireita : "";
      quadrilInput.value    = m.quadril != null ? m.quadril : "";
    }

    async function carregarMedidasLista(uid) {
      listaMedidas.innerHTML = "";

      try {
        const snapshot = await db
          .collection("medidasCorporais")
          .where("uid", "==", uid)
          .get();

        if (snapshot.empty) {
          listaMedidas.innerHTML = `
            <tr>
              <td colspan="4" style="color:#6b7280; font-size:0.85rem;">
                Nenhuma avaliação cadastrada ainda.
              </td>
            </tr>
          `;
          return;
        }

        const docs = snapshot.docs.slice();

        docs.sort((a, b) => {
          const da = a.data().data || "";
          const dbb = b.data().data || "";
          if (da < dbb) return 1;
          if (da > dbb) return -1;
          return 0;
        });

        // Preenche tabela
        docs.forEach((doc) => {
          const m = doc.data();
          const tr = document.createElement("tr");

          const tdData = document.createElement("td");
          const tdCint = document.createElement("td");
          const tdAbdS = document.createElement("td");
          const tdQuad = document.createElement("td");

          tdData.textContent = formatarDataBR(m.data);
          tdCint.textContent = fmtCm(m.cintura);
          tdAbdS.textContent = fmtCm(m.abdomenSuperior);
          tdQuad.textContent = fmtCm(m.quadril);

          tr.appendChild(tdData);
          tr.appendChild(tdCint);
          tr.appendChild(tdAbdS);
          tr.appendChild(tdQuad);

          listaMedidas.appendChild(tr);
        });

        // Pré-carrega formulário com a última avaliação
        preencherFormularioComUltima(docs[0]);
      } catch (err) {
        console.error("Erro ao carregar histórico de medidas:", err);
        listaMedidas.innerHTML = `
          <tr>
            <td colspan="4" style="color:#b91c1c; font-size:0.85rem;">
              Não foi possível carregar o histórico de medidas.
            </td>
          </tr>
        `;
      }
    }

    btnSalvarMedidas.addEventListener("click", salvarMedidas);

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "clube-login.html";
        return;
      }

      currentUid = user.uid;
      setHoje();
      await carregarMedidasLista(currentUid);
    });
  </script>
</body>
</html>
