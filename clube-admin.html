<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel Geral – Administração Prato & Peso</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Painel geral de administração do Clube Prato & Peso: clientes, pagamentos e status." />

  <style>
    :root {
      --bg: #f5f5f7;
      --bg-alt: #ffffff;
      --primary: #1e5a4d;
      --primary-soft: #e0f3ec;
      --accent: #ffb347;
      --accent-soft: #fff3df;
      --text-main: #222222;
      --text-muted: #666666;
      --border-soft: #e0e0e0;
      --radius-lg: 18px;
      --radius-xl: 22px;
      --shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.08);
      /* Aumentei um pouco a largura máxima para dar mais espaço à tabela */
      --max-width: 1240px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf5ea 0, #f5f5f7 45%, #f0f2f5 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    header {
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #4b2c15;
      font-size: 0.95rem;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
    }

    .logo-text-main {
      font-weight: 700;
      font-size: 1.05rem;
      letter-spacing: 0.03em;
    }

    .logo-text-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .badge-admin {
      font-size: 0.78rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
    }

    .btn-sair {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f5f5f7;
      font-size: 0.8rem;
      cursor: pointer;
    }

    main {
      flex: 1;
      padding: 24px 16px 40px;
    }

    .main-inner {
      max-width: var(--max-width);
      margin: 0 auto;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      font-size: 0.8rem;
      margin-bottom: 14px;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 4px;
    }

    .intro {
      font-size: 0.94rem;
      color: var(--text-muted);
      margin-bottom: 18px;
      max-width: 720px;
    }

    .grid-resumo {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 22px;
    }

    .card-mini {
      background: var(--bg-alt);
      border-radius: var(--radius-lg);
      padding: 12px 12px;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      font-size: 0.85rem;
    }

    .card-mini-label {
      color: var(--text-muted);
      font-size: 0.8rem;
      margin-bottom: 2px;
    }

    .card-mini-valor {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .card-mini-extra {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .layout-main {
      display: grid;
      /* Deixei a coluna da direita (lista) maior que o formulário */
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.1fr);
      gap: 16px;
      align-items: flex-start;
    }

    .card {
      background: var(--bg-alt);
      border-radius: var(--radius-xl);
      padding: 16px 16px 14px;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
    }

    .card h2 {
      font-size: 1rem;
      margin-bottom: 6px;
    }

    .card p {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 12px;
      margin-top: 8px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 0.8rem;
    }

    .form-group label {
      font-weight: 500;
    }

    .helper {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 7px 9px;
      font-size: 0.85rem;
      font-family: inherit;
      background: #f9fafb;
      outline: none;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary-soft);
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .btn-primary {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: #fff;
      font-size: 0.86rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,0.18);
    }

    .btn-secondary {
      padding: 7px 13px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f5f5f7;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .status-msg {
      margin-top: 6px;
      font-size: 0.8rem;
    }

    .status-erro {
      color: #b91c1c;
    }

    .status-ok {
      color: #166534;
    }

    .table-wrapper {
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      /* Agora permite rolagem horizontal se a tabela ficar grande demais */
      overflow-x: auto;
      overflow-y: hidden;
      background: #ffffff;
    }

    table {
      width: 100%;
      min-width: 700px; /* garante espaço para todas as colunas */
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      background: #f5f5f7;
    }

    th,
    td {
      padding: 7px 8px;
      border-bottom: 1px solid #eeeeee;
      vertical-align: top;
      text-align: left;
    }

    th {
      font-weight: 600;
      color: #444;
      font-size: 0.78rem;
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    .badge-status {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.73rem;
      font-weight: 600;
    }

    .badge-status.ativo {
      background: #dcfce7;
      color: #166534;
    }

    .badge-status.inativo {
      background: #fee2e2;
      color: #991b1b;
    }

    .tag-pagamento {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 1px 7px;
      font-size: 0.72rem;
      margin-right: 4px;
      margin-bottom: 2px;
    }

    .acoes-btn {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .acoes-btn button {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 0.75rem;
      padding: 3px 7px;
      cursor: pointer;
    }

    .acoes-btn button:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
    }

    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .filtros strong {
      color: var(--text-main);
    }

    .filtros input,
    .filtros select {
      font-size: 0.8rem;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
    }

    footer {
      background: #111111;
      color: #d0d0d0;
      font-size: 0.78rem;
      padding: 12px 16px 16px;
      margin-top: 28px;
    }

    .footer-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .footer-disclaimer {
      color: #aaaaaa;
      line-height: 1.4;
    }

    /* Modal de login admin */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: #ffffff;
      border-radius: 22px;
      padding: 18px 18px 16px;
      max-width: 360px;
      width: 92%;
      box-shadow: 0 16px 35px rgba(0,0,0,0.4);
    }

    .modal h2 {
      font-size: 1.1rem;
      margin-bottom: 6px;
    }

    .modal p {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .modal .form-group {
      margin-bottom: 10px;
    }

    .modal .btn-primary {
      width: 100%;
      justify-content: center;
    }

    .error-msg {
      font-size: 0.8rem;
      color: #b91c1c;
    }

    @media (max-width: 900px) {
      .layout-main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 640px) {
      main {
        padding-inline: 12px;
      }
      .header-inner {
        padding-inline: 10px;
      }
      .grid-resumo {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-badge">P&amp;P</div>
        <div>
          <div class="logo-text-main">Prato &amp; Peso</div>
          <div class="logo-text-sub">Painel geral do Clube</div>
        </div>
      </a>

      <div class="header-actions">
        <div class="badge-admin">Admin</div>
        <button type="button" class="btn-sair" id="btn-sair">Sair do painel</button>
      </div>
    </div>
  </header>

  <main>
    <div class="main-inner">
      <div class="tag">
        Visão geral • Administração do Clube
      </div>

      <h1>Painel geral de clientes</h1>
      <p class="intro">
        Aqui você enxerga de forma simples <strong>quem está ativo, quanto entra por mês</strong> 
        e consegue controlar os pagamentos. Os dados ficam salvos no seu navegador e,
        aos poucos, podemos ir integrando com o que está na nuvem.
      </p>

      <section class="grid-resumo">
        <div class="card-mini">
          <div class="card-mini-label">Total de clientes cadastrados</div>
          <div class="card-mini-valor" id="kpi-total">0</div>
          <div class="card-mini-extra" id="kpi-total-extra">Nenhum cliente ainda</div>
        </div>

        <div class="card-mini">
          <div class="card-mini-label">Clientes ativos x inativos</div>
          <div class="card-mini-valor" id="kpi-ativos">0 / 0</div>
          <div class="card-mini-extra" id="kpi-ativos-extra">—</div>
        </div>

        <div class="card-mini">
          <div class="card-mini-label">Faturamento mensal estimado</div>
          <div class="card-mini-valor" id="kpi-mensal">R$ 0,00</div>
          <div class="card-mini-extra">Somando apenas quem está ativo</div>
        </div>
      </section>

      <section class="layout-main">
        <!-- Coluna esquerda: formulário -->
        <div class="card">
          <h2>Cadastrar / editar cliente</h2>
          <p>Use este painel para montar seu "mini CRM" do Clube. Você pode cadastrar manualmente e, agora, 
            também enxerga quem já tem conta criada na plataforma.</p>

          <form id="form-cliente">
            <input type="hidden" id="cliente-id" />

            <div class="form-grid">
              <div class="form-group">
                <label for="cliente-nome">Nome do cliente</label>
                <input type="text" id="cliente-nome" placeholder="Ex.: João Silva" />
                <div class="helper">Pode ser o nome que você conhece a pessoa.</div>
              </div>

              <div class="form-group">
                <label for="cliente-inicio">Data de início no Clube</label>
                <input type="date" id="cliente-inicio" />
                <div class="helper">Quando ele começou no Clube.</div>
              </div>

              <div class="form-group">
                <label for="cliente-dia-pag">Dia de pagamento</label>
                <input type="number" id="cliente-dia-pag" min="1" max="31" />
                <div class="helper">Ex.: 10 (todo dia 10 de cada mês).</div>
              </div>

              <div class="form-group">
                <label for="cliente-valor">Valor mensal (R$)</label>
                <input type="number" id="cliente-valor" step="0.01" min="0" />
              </div>

              <div class="form-group">
                <label for="cliente-forma">Forma de pagamento</label>
                <select id="cliente-forma">
                  <option value="">Selecione...</option>
                  <option value="Pix">Pix</option>
                  <option value="Cartão crédito">Cartão crédito</option>
                  <option value="Cartão débito">Cartão débito</option>
                  <option value="Boleto">Boleto</option>
                  <option value="Dinheiro">Dinheiro</option>
                  <option value="Outro">Outro</option>
                </select>
              </div>

              <div class="form-group">
                <label for="cliente-status-pag">Status pagamento</label>
                <select id="cliente-status-pag">
                  <option value="em-dia">Em dia</option>
                  <option value="atrasado">Atrasado</option>
                  <option value="isento">Isento / cortesia</option>
                </select>
              </div>

              <div class="form-group" style="grid-column: 1 / -1;">
                <label for="cliente-observacoes">Observações</label>
                <textarea id="cliente-observacoes" placeholder="Ex.: Acesso vitalício, indicação de fulano, travar preço por 12 meses..."></textarea>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn-primary">Salvar cliente</button>
              <button type="button" class="btn-secondary" id="btn-limpar">Limpar formulário</button>
            </div>

            <div id="form-erro" class="status-msg status-erro"></div>
            <div id="form-ok" class="status-msg status-ok"></div>
          </form>
        </div>

        <!-- Coluna direita: lista -->
        <div class="card">
          <h2>Lista de clientes</h2>
          <p>Você pode filtrar, marcar ativo/inativo e usar esse resumo para organizar cobranças e renovações.</p>

          <div class="filtros">
            <div>
              <strong>Filtros rápidos</strong><br />
              <span style="font-size:0.75rem;">Use o nome ou status para encontrar mais rápido.</span>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
              <input type="text" id="filtro-nome" placeholder="Filtrar por nome..." style="max-width:180px;" />
              <select id="filtro-status" style="max-width:150px;">
                <option value="">Todos os status</option>
                <option value="ativo">Ativos</option>
                <option value="inativo">Inativos</option>
              </select>
              <button type="button" class="btn-secondary" id="btn-limpar-filtro">Limpar filtros</button>
            </div>
          </div>

          <div class="table-wrapper" style="margin-top:8px;">
            <table>
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Início / cobrança</th>
                  <th>Plano / pagamento</th>
                  <th>Status</th>
                  <th>Obs.</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="tbody-clientes">
                <!-- linhas via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="footer-inner">
      <div class="footer-disclaimer">
        <strong>Aviso:</strong> Este painel é apenas um apoio de gestão interna do Clube Prato &amp; Peso
        e não substitui controles financeiros oficiais. Use-o como referência rápida para seus clientes ativos.
      </div>
      <div style="font-size:0.75rem; color:#888888;">
        © <span id="ano-atual"></span> Prato &amp; Peso. Painel geral do Clube.
      </div>
    </div>
  </footer>

  <!-- Modal simples de login do administrador -->
  <div class="modal-backdrop" id="modal-admin" style="display:none;">
    <div class="modal">
      <h2>Acesso do administrador</h2>
      <p>
        Esta área é exclusiva sua. Digite a <strong>senha geral de administração</strong>
        que está configurada no código do site.
      </p>

      <div class="form-group">
        <label for="admin-senha">Senha do painel geral</label>
        <input type="password" id="admin-senha" />
        <div class="helper">
          Se esquecer essa senha, abra o arquivo <code>clube-admin.html</code> e procure por
          <code>ADMIN_PASSWORD</code> para ver o valor.
        </div>
      </div>

      <button type="button" class="btn-primary" id="btn-admin-entrar">Entrar</button>
      <div class="error-msg" id="admin-erro" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Firebase para buscar usuários cadastrados -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // =====================================================================
    // =========================  ATENÇÃO RAFAEL  ==========================
    // =====================================================================
    //
    //  ESTA É A SENHA GERAL DO PAINEL DE ADMINISTRAÇÃO.
    //
    //  1) Apenas você deve saber essa senha.
    //  2) Qualquer pessoa com acesso ao código-fonte CONSEGUE ver essa senha,
    //     então não use aqui algo que você usa em banco, e-mail, etc.
    //  3) Se quiser trocar, basta alterar o texto entre aspas:
    //
    //        const ADMIN_PASSWORD = "SUA-SENHA-AQUI";
    //
    // =====================================================================
    const ADMIN_PASSWORD = "PAINEL@2025";
    // ======================
    // Configuração do Firebase (mesma do restante do site)
    const firebaseConfig = {
      apiKey: "AIzaSyABfAWUAW6a6g93B9QKooTKd5Mj645G3vE",
      authDomain: "prato-e-peso-77b5a.firebaseapp.com",
      projectId: "prato-e-peso-77b5a",
      storageBucket: "prato-e-peso-77b5a.firebasestorage.app",
      messagingSenderId: "432109202072",
      appId: "1:432109202072:web:1c8636db0c161318ddfeed"
    };

    let db = null;
    if (typeof firebase !== "undefined") {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      db = firebase.firestore();
    }
    // ======================

    const ADMIN_LOGGED_KEY = "pp_admin_logado";
    const CLIENTES_KEY = "pp_admin_clientes";

    const anoSpan = document.getElementById("ano-atual");
    anoSpan.textContent = new Date().getFullYear();

    const modalAdmin = document.getElementById("modal-admin");
    const adminSenhaInput = document.getElementById("admin-senha");
    const adminErro = document.getElementById("admin-erro");
    const btnAdminEntrar = document.getElementById("btn-admin-entrar");
    const btnSair = document.getElementById("btn-sair");

    const formCliente = document.getElementById("form-cliente");
    const inputId = document.getElementById("cliente-id");
    const inputNome = document.getElementById("cliente-nome");
    const inputInicio = document.getElementById("cliente-inicio");
    const inputDiaPag = document.getElementById("cliente-dia-pag");
    const inputValor = document.getElementById("cliente-valor");
    const selectForma = document.getElementById("cliente-forma");
    const selectStatusPag = document.getElementById("cliente-status-pag");
    const inputObs = document.getElementById("cliente-observacoes");
    const btnLimparForm = document.getElementById("btn-limpar");

    const formErro = document.getElementById("form-erro");
    const formOk = document.getElementById("form-ok");

    const tbodyClientes = document.getElementById("tbody-clientes");

    const filtroNome = document.getElementById("filtro-nome");
    const filtroStatus = document.getElementById("filtro-status");
    const btnLimparFiltro = document.getElementById("btn-limpar-filtro");

    const kpiTotal = document.getElementById("kpi-total");
    const kpiTotalExtra = document.getElementById("kpi-total-extra");
    const kpiAtivos = document.getElementById("kpi-ativos");
    const kpiAtivosExtra = document.getElementById("kpi-ativos-extra");
    const kpiMensal = document.getElementById("kpi-mensal");

    let clientes = [];

    // Carrega apenas os clientes salvos manualmente no navegador
    function carregarClientes() {
      const raw = localStorage.getItem(CLIENTES_KEY);
      if (!raw) {
        clientes = [];
        return;
      }
      try {
        clientes = JSON.parse(raw);
        if (!Array.isArray(clientes)) clientes = [];
      } catch (e) {
        clientes = [];
      }
    }

    // Carrega também os usuários cadastrados no Firebase (coleção "usuarios")
    // Não salva no localStorage: sempre puxa a lista mais recente da nuvem.
    async function carregarUsuariosFirestore() {
      if (!db) {
        console.warn("Firebase/Firestore não inicializado no painel admin.");
        return;
      }

      try {
        const snap = await db.collection("usuarios").get();

        // Mapa para evitar duplicar clientes que você já cadastrou manualmente com o mesmo e-mail
        const indicePorEmail = {};
        clientes.forEach((c, idx) => {
          if (c.email) {
            indicePorEmail[c.email.toLowerCase()] = idx;
          }
        });

        snap.forEach((doc) => {
          const data = doc.data() || {};
          const email = (data.email || "").toLowerCase();
          const nome = data.nome || data.nomeCompleto || "";
          let createdAtDate = null;

          // converte Timestamp do Firestore, se existir
          if (data.createdAt && typeof data.createdAt.toDate === "function") {
            createdAtDate = data.createdAt.toDate();
          }

          const dataInicioStr = createdAtDate
            ? createdAtDate.toISOString().slice(0, 10)
            : "";

          const baseCliente = {
            id: "fs_" + doc.id,
            nome: nome,
            email: data.email || "",
            telefone: data.telefone || "",
            dataInicio: dataInicioStr,
            diaPagamento: null,
            valorMensal: null,
            formaPagamento: null,
            statusPagamento: "em-dia",
            observacoes: data.planoNome ? "Plano: " + data.planoNome : "",
            ativo: true,
            origem: data.origem || "clube",
            codigoAcesso: data.codigoAcesso || null,
            firestoreId: doc.id,
            createdAt: createdAtDate ? createdAtDate.toISOString() : null,
            dataAtualizacao: createdAtDate ? createdAtDate.toISOString() : null,
            fromFirestore: true
          };

          if (email && indicePorEmail[email] != null) {
            // Já existe um cliente manual com esse e-mail:
            // apenas enriquecemos alguns campos sem sobrescrever tudo.
            const idx = indicePorEmail[email];
            const c = clientes[idx];

            if (!c.nome && nome) c.nome = nome;
            if (!c.dataInicio && dataInicioStr) c.dataInicio = dataInicioStr;
            if (!c.origem && baseCliente.origem) c.origem = baseCliente.origem;
            if (!c.codigoAcesso && baseCliente.codigoAcesso) c.codigoAcesso = baseCliente.codigoAcesso;
            if (!c.createdAt && baseCliente.createdAt) c.createdAt = baseCliente.createdAt;
            if (!c.firestoreId) c.firestoreId = doc.id;
            c.fromFirestore = true;
          } else {
            // Novo cliente vindo do Firestore
            clientes.push(baseCliente);
          }
        });
      } catch (err) {
        console.error("Erro ao carregar usuários do Firestore:", err);
      }
    }

    function salvarClientes() {
      localStorage.setItem(CLIENTES_KEY, JSON.stringify(clientes));
    }

    function formatarValor(valor) {
      const n = Number(valor) || 0;
      return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function atualizarKpis() {
      const total = clientes.length;
      const ativos = clientes.filter(c => c.ativo !== false).length;
      const inativos = total - ativos;
      const totalMensal = clientes
        .filter(c => c.ativo !== false)
        .reduce((s, c) => s + (Number(c.valorMensal) || 0), 0);

      kpiTotal.textContent = total.toString();
      kpiTotalExtra.textContent = total === 0 ? "Nenhum cliente cadastrado" : "Total geral no painel";

      kpiAtivos.textContent = `${ativos} / ${inativos}`;
      kpiAtivosExtra.textContent = ativos === 0
        ? "Nenhum cliente ativo"
        : `${ativos} ativo(s), ${inativos} inativo(s)`;

      kpiMensal.textContent = formatarValor(totalMensal);
    }

    function limparFormulario() {
      inputId.value = "";
      inputNome.value = "";
      inputInicio.value = "";
      inputDiaPag.value = "";
      inputValor.value = "";
      selectForma.value = "";
      selectStatusPag.value = "em-dia";
      inputObs.value = "";
      formErro.textContent = "";
      formOk.textContent = "";
    }

    function preencherFormulario(cliente) {
      inputId.value = cliente.id || "";
      inputNome.value = cliente.nome || "";
      inputInicio.value = cliente.dataInicio || "";
      inputDiaPag.value = cliente.diaPagamento != null ? cliente.diaPagamento : "";
      inputValor.value = cliente.valorMensal != null ? cliente.valorMensal : "";
      selectForma.value = cliente.formaPagamento || "";
      selectStatusPag.value = cliente.statusPagamento || "em-dia";
      inputObs.value = cliente.observacoes || "";
      formErro.textContent = "";
      formOk.textContent = "";
    }

    function renderTabela() {
      const filtroNomeVal = (filtroNome.value || "").toLowerCase();
      const filtroStatusVal = filtroStatus.value;

      let lista = clientes.slice();

      if (filtroNomeVal) {
        lista = lista.filter(c =>
          (c.nome || "").toLowerCase().includes(filtroNomeVal)
        );
      }

      if (filtroStatusVal === "ativo") {
        lista = lista.filter(c => c.ativo !== false);
      } else if (filtroStatusVal === "inativo") {
        lista = lista.filter(c => c.ativo === false);
      }

      tbodyClientes.innerHTML = "";

      const hoje = new Date();
      const hojeDia = hoje.getDate();

      const linhas = lista.map(cliente => {
        const diaPag = cliente.diaPagamento ? Number(cliente.diaPagamento) : null;
        let infoCobranca = "";
        if (diaPag) {
          infoCobranca = `Dia ${diaPag}`;
          if (diaPag < hojeDia - 3) {
            infoCobranca += " • cobrança já passou esse mês";
          } else if (diaPag >= hojeDia && diaPag <= hojeDia + 3) {
            infoCobranca += " • cobrança próxima";
          } else if (diaPag < hojeDia) {
            infoCobranca += " • cobrança deste mês já passou";
          }
        } else {
          infoCobranca = "—";
        }

        const inicio = cliente.dataInicio || "—";
        const valor = cliente.valorMensal != null ? formatarValor(cliente.valorMensal) : "—";
        const forma = cliente.formaPagamento || "—";

        const obs = cliente.observacoes ? cliente.observacoes : "—";

        const dtCriacao = cliente.createdAt
          ? new Date(cliente.createdAt).toLocaleDateString("pt-BR")
          : "—";

        const dtUltAtividade = cliente.dataAtualizacao
          ? new Date(cliente.dataAtualizacao).toLocaleDateString("pt-BR")
          : dtCriacao;

        const statusTexto = cliente.ativo === false ? "Inativo" : "Ativo";
        const statusClasse = cliente.ativo === false ? "inativo" : "ativo";

        const statusPag = cliente.statusPagamento || "em-dia";
        let textoStatusPag = "Em dia";
        if (statusPag === "atrasado") textoStatusPag = "Atrasado";
        if (statusPag === "isento") textoStatusPag = "Isento / cortesia";

        return `
          <tr>
            <td>
              <div><strong>${cliente.nome || "(sem nome)"}</strong></div>
              <div style="font-size:0.75rem; color:#666;">
                ${cliente.email ? cliente.email : ""} 
              </div>
            </td>
            <td>
              <div style="font-size:0.8rem;">Início: ${inicio}</div>
              <div style="font-size:0.75rem; color:#666;">${infoCobranca}</div>
            </td>
            <td>
              <div style="font-size:0.8rem;">${valor}</div>
              <div style="font-size:0.75rem; color:#666;">${forma}</div>
            </td>
            <td>
              <div class="badge-status ${statusClasse}">${statusTexto}</div>
              <div style="font-size:0.73rem; margin-top:3px;">
                <span class="tag-pagamento">${textoStatusPag}</span>
              </div>
              <div style="font-size:0.7rem; color:#999; margin-top:3px;">
                Cadastrado: ${dtCriacao}<br/>
                Última atividade: ${dtUltAtividade}
              </div>
            </td>
            <td style="font-size:0.75rem;">${obs}</td>
            <td>
              <div class="acoes-btn">
                <button type="button" onclick="editarCliente('${cliente.id}')">Editar</button>
                <button type="button" onclick="alternarAtivo('${cliente.id}')">
                  ${cliente.ativo === false ? "Reativar" : "Desativar"}
                </button>
                <button type="button" onclick="duplicarCliente('${cliente.id}')">Duplicar</button>
                <button type="button" onclick="excluirCliente('${cliente.id}')">Excluir</button>
              </div>
            </td>
          </tr>
        `;
      });

      tbodyClientes.innerHTML = linhas.join("");
    }

    // Ações
    formCliente.addEventListener("submit", function (e) {
      e.preventDefault();
      formErro.textContent = "";
      formOk.textContent = "";

      const nome = inputNome.value.trim();
      if (!nome) {
        formErro.textContent = "Informe pelo menos o nome do cliente.";
        return;
      }

      const idExistente = inputId.value || null;
      const hojeIso = new Date().toISOString();

      let createdAt = hojeIso;
      if (idExistente) {
        const idxExistente = clientes.findIndex(c => c.id === idExistente);
        if (idxExistente !== -1 && clientes[idxExistente].createdAt) {
          createdAt = clientes[idxExistente].createdAt;
        }
      }

      const clienteDados = {
        id: idExistente || "cli_" + Date.now(),
        nome: nome,
        dataInicio: inputInicio.value || "",
        diaPagamento: inputDiaPag.value ? Number(inputDiaPag.value) : null,
        valorMensal: inputValor.value ? Number(inputValor.value) : null,
        formaPagamento: selectForma.value || "",
        statusPagamento: selectStatusPag.value || "em-dia",
        observacoes: inputObs.value || "",
        ativo: true,
        createdAt: createdAt,
        dataAtualizacao: hojeIso
      };

      if (idExistente) {
        const idx = clientes.findIndex(c => c.id === idExistente);
        if (idx !== -1) {
          clientes[idx] = { ...clientes[idx], ...clienteDados };
        }
      } else {
        clientes.push(clienteDados);
      }

      salvarClientes();
      atualizarKpis();
      renderTabela();
      formOk.textContent = "Cliente salvo com sucesso.";
      inputId.value = clienteDados.id;
    });

    btnLimparForm.addEventListener("click", function () {
      limparFormulario();
    });

    filtroNome.addEventListener("input", renderTabela);
    filtroStatus.addEventListener("change", renderTabela);
    btnLimparFiltro.addEventListener("click", function () {
      filtroNome.value = "";
      filtroStatus.value = "";
      renderTabela();
    });

    // Funções globais para usar nos botões da tabela
    window.editarCliente = function (id) {
      const cliente = clientes.find(c => c.id === id);
      if (!cliente) return;
      preencherFormulario(cliente);
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    window.alternarAtivo = function (id) {
      const idx = clientes.findIndex(c => c.id === id);
      if (idx === -1) return;
      const atual = clientes[idx];
      clientes[idx].ativo = atual.ativo === false ? true : false;
      clientes[idx].dataAtualizacao = new Date().toISOString();
      salvarClientes();
      atualizarKpis();
      renderTabela();
    };

    window.duplicarCliente = function (id) {
      const cliente = clientes.find(c => c.id === id);
      if (!cliente) return;
      const agoraIso = new Date().toISOString();
      const copia = {
        ...cliente,
        id: "cli_" + Date.now(),
        nome: (cliente.nome || "(sem nome)") + " (cópia)",
        createdAt: agoraIso,
        dataAtualizacao: agoraIso
      };
      clientes.push(copia);
      salvarClientes();
      atualizarKpis();
      renderTabela();
    };

    window.excluirCliente = async function (id) {
      const idx = clientes.findIndex(c => c.id === id);
      if (idx === -1) return;

      const cliente = clientes[idx];
      const nome = cliente.nome || "este cliente";

      const confirmar = window.confirm(`Tem certeza de que deseja excluir ${nome}? Essa ação não poderá ser desfeita.`);
      if (!confirmar) return;

      // Se veio do Firestore, tenta remover também da coleção "usuarios"
      if (cliente.fromFirestore && cliente.firestoreId && db) {
        try {
          await db.collection("usuarios").doc(cliente.firestoreId).delete();
        } catch (erro) {
          console.error("Erro ao excluir cliente no Firestore:", erro);
          alert("Cliente removido do painel, mas houve um erro ao excluir no Firebase. Verifique depois no console do Firebase.");
        }
      }

      clientes.splice(idx, 1);
      salvarClientes();
      atualizarKpis();
      renderTabela();
    };

    // Modal admin
    function abrirModalAdmin() {
      modalAdmin.style.display = "flex";
      adminErro.textContent = "";
      adminSenhaInput.value = "";
      adminSenhaInput.focus();
    }

    function fecharModalAdmin() {
      modalAdmin.style.display = "none";
    }

    btnAdminEntrar.addEventListener("click", function () {
      const senha = adminSenhaInput.value;
      if (!senha) {
        adminErro.textContent = "Digite a senha do painel.";
        return;
      }
      if (senha !== ADMIN_PASSWORD) {
        adminErro.textContent = "Senha incorreta.";
        return;
      }
      localStorage.setItem(ADMIN_LOGGED_KEY, "true");
      adminErro.textContent = "";
      iniciarPainel();
      fecharModalAdmin();
    });

    btnSair.addEventListener("click", function () {
      localStorage.removeItem(ADMIN_LOGGED_KEY);
      window.location.href = "clube-login.html";
    });

    async function iniciarPainel() {
      // Primeiro carrega os clientes que você já cadastrou manualmente
      carregarClientes();

      // Depois traz também os usuários cadastrados no Firebase (coleção "usuarios")
      await carregarUsuariosFirestore();

      // Atualiza os indicadores e a tabela com a junção de tudo
      atualizarKpis();
      renderTabela();
    }

    // Verifica se já está logado como admin
    document.addEventListener("DOMContentLoaded", function () {
      const logado = localStorage.getItem(ADMIN_LOGGED_KEY) === "true";
      if (!logado) {
        abrirModalAdmin();
      } else {
        iniciarPainel();
      }
    });
  </script>
</body>
</html>
