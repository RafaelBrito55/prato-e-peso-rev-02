<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Clube Prato & Peso – Meu TDEE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f5f5f7;
      --bg-alt: #ffffff;
      --primary: #1e5a4d;
      --primary-soft: #e0f3ec;
      --accent: #ffb347;
      --accent-soft: #fff3df;
      --text-main: #222222;
      --text-muted: #666666;
      --border-soft: #e0e0e0;
      --radius-lg: 16px;
      --radius-xl: 22px;
      --shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.08);
      --max-width: 1040px;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf5ea 0, #f5f5f7 45%, #f0f2f5 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: rgba(255,255,255,0.96);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit;
    }
    .logo-badge {
      width: 30px; height: 30px;
      border-radius: 50%;
      background: var(--accent);
      display:flex; align-items:center; justify-content:center;
      font-weight:700; color:#4b2c15; font-size:0.9rem;
      box-shadow: 0 6px 14px rgba(0,0,0,0.1);
    }
    .logo-text { display:flex; flex-direction:column; gap:2px; }
    .logo-text-main { font-weight:700; font-size:0.98rem; letter-spacing:0.03em; }
    .logo-text-sub { font-size:0.75rem; color:var(--text-muted); }

    .header-right {
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .header-pill {
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:#f5f5f7;
      font-size:0.8rem;
      cursor:pointer;
    }

    main {
      flex:1;
      padding:24px 16px 40px;
    }
    .main-inner {
      max-width:var(--max-width);
      margin:0 auto;
    }

    .card {
      background:var(--bg-alt);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow-soft);
      border:1px solid var(--border-soft);
      padding:18px 16px;
      margin-bottom:18px;
    }

    h1 {
      font-size:1.3rem;
      margin-bottom:4px;
    }

    .card small {
      color:var(--text-muted);
      font-size:0.85rem;
    }

    label {
      display:block;
      font-size:0.85rem;
      margin-top:12px;
      margin-bottom:4px;
    }

    input[type="number"],
    input[type="text"],
    select {
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-size:0.9rem;
      background:#f9fafb;
    }

    input:focus, select:focus {
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 1px var(--primary-soft);
      background:#fff;
    }

    .row { display:flex; flex-wrap:wrap; gap:12px; margin-top:6px; }
    .col { flex:1; min-width:140px; }

    button.primary {
      margin-top:14px;
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:999px;
      padding:9px 18px;
      font-size:0.9rem;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,0.18);
    }

    .message {
      margin-top:8px;
      font-size:0.85rem;
      display:none;
    }
    .message.ok { color:#15803d; }
    .message.error { color:#b91c1c; }

    .resultado-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(190px,1fr));
      gap:12px;
      margin-top:12px;
    }
    .resultado-item {
      background:#f9fafb;
      border-radius:var(--radius-lg);
      padding:10px 12px;
      border:1px solid #e5e7eb;
      font-size:0.88rem;
    }
    .resultado-item strong {
      font-size:1.1rem;
      display:block;
      margin-bottom:2px;
    }
    .resultado-item span {
      font-size:0.8rem;
      color:var(--text-muted);
    }

    footer {
      background:#111;
      color:#d0d0d0;
      font-size:0.78rem;
      padding:12px 16px 16px;
      margin-top:12px;
    }
    .footer-inner {
      max-width:var(--max-width);
      margin:0 auto;
      text-align:center;
    }

    @media (max-width:640px) {
      main { padding-inline:12px; }
      .header-inner { padding-inline:10px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <a href="clube-area.html" class="logo">
        <div class="logo-badge">P&amp;P</div>
        <div class="logo-text">
          <div class="logo-text-main">Prato &amp; Peso</div>
          <div class="logo-text-sub">Clube – TDEE</div>
        </div>
      </a>

      <div class="header-right">
        <button class="header-pill" onclick="window.location.href='clube-area.html'">← Voltar para o Clube</button>
      </div>
    </div>
  </header>

  <main>
    <div class="main-inner">
      <section class="card">
        <h1>Meu TDEE no Clube</h1>
        <small>Calcule seu gasto calórico diário e defina a meta de emagrecimento. O resultado fica salvo na sua conta.</small>

        <div class="row">
          <div class="col">
            <label for="sexo">Sexo</label>
            <select id="sexo">
              <option value="">Selecione</option>
              <option value="M">Masculino</option>
              <option value="F">Feminino</option>
            </select>
          </div>
          <div class="col">
            <label for="idade">Idade (anos)</label>
            <input type="number" id="idade" min="10" max="120" />
          </div>
          <div class="col">
            <label for="peso">Peso (kg)</label>
            <input type="number" id="peso" step="0.1" min="20" />
          </div>
          <div class="col">
            <label for="altura">Altura (cm)</label>
            <input type="number" id="altura" step="0.1" min="120" />
          </div>
        </div>

        <label for="atividade" style="margin-top:14px;">Nível de atividade</label>
        <select id="atividade">
          <option value="">Selecione</option>
          <option value="1.2">Sedentário (pouco ou nenhum exercício)</option>
          <option value="1.375">Levemente ativo (1–3 treinos/sem)</option>
          <option value="1.55">Moderadamente ativo (3–5 treinos/sem)</option>
          <option value="1.725">Muito ativo (6–7 treinos/sem)</option>
          <option value="1.9">Extremamente ativo (trabalho físico pesado)</option>
        </select>

        <label for="objetivo" style="margin-top:14px;">Objetivo</label>
        <select id="objetivo">
          <option value="manter">Manter peso</option>
          <option value="emagrecer_leve">Emagrecer leve (~10%)</option>
          <option value="emagrecer_normal">Emagrecer normal (~20%)</option>
          <option value="emagrecer_agressivo">Emagrecer mais rápido (~25%)</option>
          <option value="ganhar">Ganho de peso/hipertrofia (+15%)</option>
        </select>

        <button class="primary" id="btnCalcular">Calcular e salvar no Clube</button>
        <div id="msg" class="message"></div>

        <div id="blocoResultados" style="display:none;">
          <div class="resultado-grid">
            <div class="resultado-item">
              <span>Gasto basal (BMR)</span>
              <strong id="bmrOut">–</strong>
              <span>Calorias que seu corpo gasta em repouso.</span>
            </div>
            <div class="resultado-item">
              <span>TDEE estimado</span>
              <strong id="tdeeOut">–</strong>
              <span>Gasto total diário com atividade.</span>
            </div>
            <div class="resultado-item">
              <span>Calorias da meta</span>
              <strong id="metaOut">–</strong>
              <span id="metaTipoOut">Meta de manutenção/emagrecimento.</span>
            </div>
            <div class="resultado-item">
              <span>Déficit / superávit diário</span>
              <strong id="deficitOut">–</strong>
              <span id="velocidadeOut">Estimativa de velocidade por semana.</span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="footer-inner">
      © <span id="anoAtual"></span> Prato &amp; Peso – Clube. Dados salvos na sua conta.
    </div>
  </footer>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyABfAWUAW6a6g93B9QKooTKd5Mj645G3vE",
      authDomain: "prato-e-peso-77b5a.firebaseapp.com",
      projectId: "prato-e-peso-77b5a",
      storageBucket: "prato-e-peso-77b5a.firebasestorage.app",
      messagingSenderId: "432109202072",
      appId: "1:432109202072:web:1c8636db0c161318ddfeed"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const anoAtualSpan = document.getElementById("anoAtual");
    anoAtualSpan.textContent = new Date().getFullYear();

    const sexoInput = document.getElementById("sexo");
    const idadeInput = document.getElementById("idade");
    const pesoInput = document.getElementById("peso");
    const alturaInput = document.getElementById("altura");
    const atividadeInput = document.getElementById("atividade");
    const objetivoInput = document.getElementById("objetivo");
    const btnCalcular = document.getElementById("btnCalcular");
    const msg = document.getElementById("msg");

    const blocoResultados = document.getElementById("blocoResultados");
    const bmrOut = document.getElementById("bmrOut");
    const tdeeOut = document.getElementById("tdeeOut");
    const metaOut = document.getElementById("metaOut");
    const metaTipoOut = document.getElementById("metaTipoOut");
    const deficitOut = document.getElementById("deficitOut");
    const velocidadeOut = document.getElementById("velocidadeOut");

    let currentUid = null;

    function mostrarMsg(texto, tipo) {
      msg.style.display = texto ? "block" : "none";
      msg.textContent = texto || "";
      msg.classList.remove("ok","error");
      if (tipo === "ok") msg.classList.add("ok");
      if (tipo === "error") msg.classList.add("error");
    }

    function calcularTDEE() {
      const sexo = sexoInput.value;
      const idade = parseInt(idadeInput.value);
      const peso = parseFloat(pesoInput.value);
      const altura = parseFloat(alturaInput.value);
      const fator = parseFloat(atividadeInput.value);
      const objetivo = objetivoInput.value;

      if (!sexo || isNaN(idade) || isNaN(peso) || isNaN(altura) || isNaN(fator)) {
        mostrarMsg("Preencha todos os campos para calcular.", "error");
        return null;
      }

      // Mifflin-St Jeor
      let bmr;
      if (sexo === "M") {
        bmr = 10 * peso + 6.25 * altura - 5 * idade + 5;
      } else {
        bmr = 10 * peso + 6.25 * altura - 5 * idade - 161;
      }

      const tdee = bmr * fator;

      let metaMultiplicador = 1;
      let metaTipoLabel = "Manter peso";

      switch (objetivo) {
        case "emagrecer_leve":
          metaMultiplicador = 0.90;
          metaTipoLabel = "Emagrecer leve (~10%)";
          break;
        case "emagrecer_normal":
          metaMultiplicador = 0.80;
          metaTipoLabel = "Emagrecer normal (~20%)";
          break;
        case "emagrecer_agressivo":
          metaMultiplicador = 0.75;
          metaTipoLabel = "Emagrecer mais rápido (~25%)";
          break;
        case "ganhar":
          metaMultiplicador = 1.15;
          metaTipoLabel = "Ganho de peso/hipertrofia (+15%)";
          break;
        default:
          metaMultiplicador = 1;
          metaTipoLabel = "Manter peso";
      }

      const metaCalorias = tdee * metaMultiplicador;
      const deficitDia = metaCalorias - tdee; // negativo = déficit

      // estimativa em kg/semana (7.700 kcal ~ 1 kg de gordura)
      let kgSemana = null;
      if (deficitDia !== 0) {
        kgSemana = (deficitDia * 7) / 7700;
      }

      return {
        bmr,
        tdee,
        metaCalorias,
        deficitDia,
        kgSemana,
        metaTipoLabel,
        fator
      };
    }

    async function salvarNoClube(resultado) {
      if (!currentUid) {
        mostrarMsg("Não foi possível identificar sua conta. Faça login novamente.", "error");
        return;
      }

      mostrarMsg("Salvando no Clube...", "ok");
      btnCalcular.disabled = true;

      try {
        await db.collection("tdee").add({
          uid: currentUid,
          dataCalculo: firebase.firestore.FieldValue.serverTimestamp(),
          tdee: resultado.tdee,
          gastoBasal: resultado.bmr,
          metodo: "Mifflin-St Jeor",
          nivelAtividade: resultado.fator,
          metaTipo: resultado.metaTipoLabel,
          metaCalorias: resultado.metaCalorias,
          metaDeficitDia: resultado.deficitDia,
          metaKgSemana: resultado.kgSemana
        });

        mostrarMsg("Cálculo salvo com sucesso no Clube! ✅", "ok");
      } catch (err) {
        console.error("Erro ao salvar TDEE:", err);
        mostrarMsg("Erro ao salvar no Clube. Tente novamente.", "error");
      } finally {
        btnCalcular.disabled = false;
      }
    }

    btnCalcular.addEventListener("click", async () => {
      mostrarMsg("");
      const res = calcularTDEE();
      if (!res) return;

      const bmrFmt = Math.round(res.bmr).toLocaleString("pt-BR");
      const tdeeFmt = Math.round(res.tdee).toLocaleString("pt-BR");
      const metaFmt = Math.round(res.metaCalorias).toLocaleString("pt-BR");

      let deficitLabel;
      if (res.deficitDia === 0) {
        deficitLabel = "0 kcal/dia (sem déficit)";
      } else {
        const valor = Math.abs(Math.round(res.deficitDia)).toLocaleString("pt-BR");
        deficitLabel = (res.deficitDia < 0 ? "-" : "+") + valor + " kcal/dia";
      }

      let velLabel = "Sem alteração relevante";
      if (res.kgSemana !== null && res.kgSemana !== 0) {
        const kgAbs = Math.abs(res.kgSemana).toLocaleString("pt-BR", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        velLabel =
          (res.kgSemana < 0 ? "Perda" : "Ganho") + " estimado de ~" + kgAbs + " kg/semana";
      }

      bmrOut.textContent = bmrFmt + " kcal";
      tdeeOut.textContent = tdeeFmt + " kcal";
      metaOut.textContent = metaFmt + " kcal";
      metaTipoOut.textContent = res.metaTipoLabel;
      deficitOut.textContent = deficitLabel;
      velocidadeOut.textContent = velLabel;
      blocoResultados.style.display = "block";

      await salvarNoClube(res);
    });

    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "clube-login.html";
        return;
      }
      currentUid = user.uid;
    });
  </script>
</body>
</html>
